<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enquiry Analytics - TCF Pricing Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            position: relative;
            height: 350px;
            width: 100%;
        }
    </style>
</head>

<body class="dashboard-body">
    <div class="dashboard-layout">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="material-icons-round">wind_power</span>
                </div>
                <div>
                    <h2>TCF Tool</h2>
                    <div class="version-badge">v7.0</div>
                </div>
            </div>
            <ul class="nav-links">
                <li><a href="{{ url_for('index') }}" class="nav-item"><span
                            class="material-icons-round">home</span>Home</a></li>
                <li><a href="{{ url_for('dashboard') }}" class="nav-item"><span
                            class="material-icons-round">analytics</span>Dashboard</a></li>
                <li><a href="{{ url_for('enquiry_register') }}" class="nav-item active"><span
                            class="material-icons-round">assignment</span>Enquiry Register</a></li>
                <li><a href="{{ url_for('orders_dashboard') }}" class="nav-item"><span
                            class="material-icons-round">insights</span>Order Details</a></li>
                <li><a href="{{ url_for('customers_directory') }}" class="nav-item"><span
                            class="material-icons-round">groups</span>Customer 360</a></li>
                {% if session.get('is_admin') %}
                <li><a href="{{ url_for('db_admin.index') }}" class="nav-item"><span
                            class="material-icons-round">settings</span>DB Admin</a></li>
                {% endif %}
                <li class="nav-spacer"></li>
                <li><a href="{{ url_for('logout') }}" class="nav-item text-error"><span
                            class="material-icons-round">logout</span>Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="dashboard-main">
            <header class="dashboard-topbar"
                style="display: flex; flex-direction: column; gap: 1rem; padding-bottom: 0;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                    <div class="title-area">
                        <h1>Enquiry Analytics</h1>
                        <p class="subtitle">Unified view of sales pipeline and tracking status</p>
                    </div>
                    <div class="user-profile">
                        <span class="material-icons-round">account_circle</span>
                        <span>{{ session.get('full_name', 'User') }}</span>
                    </div>
                </div>

                <!-- Modern Interactive Filter Bar (Direct clone of Orders) -->
                <div class="filter-bar"
                    style="background: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; gap: 1.5rem; align-items: center; border: 1px solid #e2e8f0; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons-round"
                            style="color: #64748b; font-size: 1.2rem;">calendar_month</span>
                        <select id="filter-year"
                            style="border: none; background: #f8fafc; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; color: #0f172a; outline: none; cursor: pointer;">
                            <option value="All">All Years</option>
                        </select>
                    </div>

                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons-round" style="color: #64748b; font-size: 1.2rem;">person</span>
                        <select id="filter-se"
                            style="border: none; background: #f8fafc; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; color: #334155; outline: none; cursor: pointer;">
                            <option value="All">All Engineers</option>
                        </select>
                    </div>

                    <div style="flex-grow: 1;"></div>

                    <div
                        style="font-size: 0.85rem; color: #64748b; background: #f1f5f9; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 500;">
                        <span class="material-icons-round"
                            style="font-size: 1rem; vertical-align: middle; margin-right: 4px; color: #3b82f6">info</span>
                        Comparing vs <span id="ytd-compare-label">Previous Year</span> YTD
                    </div>
                </div>
            </header>

            <!-- KPI Grid -->
            <div class="kpi-grid" id="kpi-container" style="margin-top: 1rem;">
                <!-- Total Enquiries (Register Count) -->
                <div class="kpi-card"
                    style="box-shadow: 0 10px 25px rgba(59, 130, 246, 0.1); border-top: 4px solid #3b82f6;">
                    <div class="kpi-icon"><span class="material-icons-round">assignment</span></div>
                    <div class="kpi-data" style="width: 100%;">
                        <p>Total Enquiries (Volume)</p>
                        <h3 id="kpi-total" style="font-size: 1.8rem;">--</h3>
                        <div id="kpi-total-ytd"
                            style="font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 4px; margin-top: 0.5rem;">
                        </div>
                    </div>
                </div>

                <!-- Live in Pricing (App Count) -->
                <div class="kpi-card"
                    style="box-shadow: 0 10px 25px rgba(16, 185, 129, 0.1); border-top: 4px solid #10b981;">
                    <div class="kpi-icon success"><span class="material-icons-round">check_circle</span></div>
                    <div class="kpi-data" style="width: 100%;">
                        <p>Live in Pricing Tool</p>
                        <h3 id="kpi-live" style="font-size: 1.8rem;">--</h3>
                        <div id="kpi-live-ytd"
                            style="font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 4px; margin-top: 0.5rem;">
                        </div>
                    </div>
                </div>

                <!-- Unique Customers -->
                <div class="kpi-card"
                    style="box-shadow: 0 10px 25px rgba(139, 92, 246, 0.1); border-top: 4px solid #8b5cf6;">
                    <div class="kpi-icon" style="background: #ede9fe; color: #8b5cf6;"><span
                            class="material-icons-round">groups</span></div>
                    <div class="kpi-data" style="width: 100%;">
                        <p>Unique Customers</p>
                        <h3 id="kpi-customers" style="font-size: 1.8rem;">--</h3>
                        <div id="kpi-customers-ytd"
                            style="font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 4px; margin-top: 0.5rem;">
                        </div>
                    </div>
                </div>

                <!-- Potential Value -->
                <div class="kpi-card"
                    style="box-shadow: 0 10px 25px rgba(245, 158, 11, 0.1); border-top: 4px solid #f59e0b;">
                    <div class="kpi-icon warning"><span class="material-icons-round">payments</span></div>
                    <div class="kpi-data" style="width: 100%;">
                        <p>Enquiry Value (Live)</p>
                        <h3 id="kpi-value" style="font-size: 1.8rem;">₹ --</h3>
                        <div id="kpi-value-ytd"
                            style="font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 4px; margin-top: 0.5rem;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trend Chart -->
            <div class="chart-container" style="height: 380px; margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.1rem; color: #0f172a; margin-bottom: 1rem; font-weight: 600;">Monthly Enquiry
                    Trend</h3>
                <canvas id="trendChart"></canvas>
            </div>

            <!-- Breakdown Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">

                <!-- Region Chart -->
                <div class="card panel"
                    style="display: flex; flex-direction: column; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; max-height: 500px;">
                    <div class="card-header"
                        style="background: linear-gradient(to right, #ffffff, #f8fafc); border-bottom: 1px solid #e2e8f0; padding: 1.25rem 1.5rem;">
                        <h2
                            style="font-size: 1.1rem; color: #0f172a; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons-round" style="color: #10b981;">map</span>
                            Enquiries by Region
                        </h2>
                    </div>
                    <div class="card-body" style="padding: 1.5rem; flex-grow: 1; height: 350px;">
                        <canvas id="regionChart"></canvas>
                    </div>
                </div>

                <!-- Sales Engineer Performance -->
                <div class="card panel"
                    style="display: flex; flex-direction: column; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; max-height: 500px; overflow: hidden;">
                    <div class="card-header"
                        style="background: linear-gradient(to right, #ffffff, #f8fafc); border-bottom: 1px solid #e2e8f0; padding: 1.25rem 1.5rem;">
                        <h2
                            style="font-size: 1.1rem; color: #0f172a; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons-round" style="color: #3b82f6;">assignment_ind</span>
                            Sales Engineers
                        </h2>
                    </div>
                    <div class="card-body" style="padding: 0; overflow-y: auto;" id="se-performance-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Top Customers -->
                <div class="card panel"
                    style="display: flex; flex-direction: column; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; max-height: 500px; overflow: hidden;">
                    <div class="card-header"
                        style="background: linear-gradient(to right, #ffffff, #f8fafc); border-bottom: 1px solid #e2e8f0; padding: 1rem 1.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
                        <h2
                            style="font-size: 1.1rem; color: #0f172a; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons-round" style="color: #f59e0b;">corporate_fare</span>
                            Customers
                        </h2>
                        <input type="text" id="customer-search" placeholder="Search customer..."
                            style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; outline: none; font-size: 0.85rem;">
                    </div>
                    <div class="card-body" style="padding: 0; overflow-y: auto;" id="customer-performance-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Lost Reasons -->
                <div class="card panel"
                    style="display: flex; flex-direction: column; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; max-height: 500px;">
                    <div class="card-header"
                        style="background: linear-gradient(to right, #ffffff, #f8fafc); border-bottom: 1px solid #e2e8f0; padding: 1.25rem 1.5rem;">
                        <h2
                            style="font-size: 1.1rem; color: #0f172a; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons-round" style="color: #ef4444;">pie_chart</span>
                            Lost Reasons
                        </h2>
                    </div>
                    <div class="card-body" style="padding: 1.5rem; flex-grow: 1; height: 350px;">
                        <canvas id="lostReasonChart"></canvas>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- 6-Year Historical Comparison Matrix -->
    <div style="margin-top: 2rem; margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3
                style="font-size: 1.25rem; color: #0f172a; margin: 0; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-icons-round" style="color: #6366f1;">history</span>
                Historical Enquiry Comparison
            </h3>
            <div>
                <select id="six-year-filter"
                    style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid #cbd5e1; outline: none; font-family: inherit; font-size: 0.9rem; font-weight: 500; color: #1e293b; background: white; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                    <option value="YTD">YTD (Up to Current Month)</option>
                    <option value="Full">Full Year</option>
                </select>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem;">
            <div class="card panel"
                style="background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; padding: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 1rem; color: #475569; font-weight: 600;">Enquiry Value (Live)
                </h4>
                <div style="height: 250px;"><canvas id="histValueChart"></canvas></div>
            </div>
            <div class="card panel"
                style="background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; padding: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 1rem; color: #475569; font-weight: 600;">Enquiry Volume
                    (Count)</h4>
                <div style="height: 250px;"><canvas id="histQtyChart"></canvas></div>
            </div>
            <div class="card panel"
                style="background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; padding: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 1rem; color: #475569; font-weight: 600;">Unique Customers</h4>
                <div style="height: 250px;"><canvas id="histCustChart"></canvas></div>
            </div>
        </div>
    </div>
    </main>
    </div>

    <!-- Drilldown Modal (Enhanced with Chart) -->
    <div id="drilldownModal"
        style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div
            style="background: white; width: 90%; max-width: 900px; max-height: 90vh; border-radius: 16px; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); overflow: hidden;">
            <div
                style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 id="modal-entity-name" style="margin: 0; font-size: 1.5rem; color: #0f172a; font-weight: 600;">
                        Entity Name</h2>
                    <p id="modal-subtitle" style="margin: 0; color: #64748b; font-size: 0.9rem; margin-top: 4px;">
                        Enquiry History</p>
                </div>
                <button onclick="closeDrilldownModal()"
                    style="background: none; border: none; cursor: pointer; color: #64748b;"><span
                        class="material-icons-round">close</span></button>
            </div>

            <!-- Modal Chart Section -->
            <div style="padding: 1rem 1.5rem; background: #fff; border-bottom: 1px solid #e2e8f0; height: 200px;">
                <canvas id="modalYearChart"></canvas>
            </div>

            <div
                style="padding: 1.5rem; display: flex; justify-content: space-around; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <div style="text-align: center;">
                    <p
                        style="margin: 0; color: #64748b; font-size: 0.85rem; font-weight: 500; text-transform: uppercase;">
                        Total Enquiries</p>
                    <h3 id="modal-total-qty"
                        style="margin: 0; margin-top: 4px; font-size: 1.4rem; color: #0f172a; font-weight: 600;">0</h3>
                </div>
                <div style="text-align: center;">
                    <p
                        style="margin: 0; color: #64748b; font-size: 0.85rem; font-weight: 500; text-transform: uppercase;">
                        Potential Value</p>
                    <h3 id="modal-total-value"
                        style="margin: 0; margin-top: 4px; font-size: 1.4rem; color: #0f172a; font-weight: 600;">₹0</h3>
                </div>
            </div>
            <div style="padding: 0; overflow-y: auto; flex-grow: 1;">
                <table class="data-table" id="modal-orders-table" style="width: 100%; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; z-index: 10; background: #f8fafc;">
                        <tr style="border-bottom: 2px solid #e2e8f0;">
                            <th
                                style="padding: 1rem; text-align: left; color: #475569; font-weight: 600; font-size: 0.9rem;">
                                Enquiry #</th>
                            <th
                                style="padding: 1rem; text-align: left; color: #475569; font-weight: 600; font-size: 0.9rem;">
                                Period</th>
                            <th
                                style="padding: 1rem; text-align: left; color: #475569; font-weight: 600; font-size: 0.9rem;">
                                Customer Name</th>
                            <th
                                style="padding: 1rem; text-align: left; color: #475569; font-weight: 600; font-size: 0.9rem;">
                                Pricing Status</th>
                            <th
                                style="padding: 1rem; text-align: right; color: #475569; font-weight: 600; font-size: 0.9rem;">
                                Value</th>
                        </tr>
                    </thead>
                    <tbody style="font-size: 0.9rem;" id="modal-table-body">
                        <!-- JS injected -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Application Script -->
    <script src="{{ url_for('static', filename='js/enquiry_register.js') }}"></script>
</body>

</html>