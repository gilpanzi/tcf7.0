<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Summary - {{ project.enquiry_number }}</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ range(1000, 9999) | random }}">
    <style>
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.8) 100%);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            padding: 2px;
            background: linear-gradient(135deg, var(--primary-300), var(--secondary-300), var(--accent-300));
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            -webkit-mask-composite: xor;
            z-index: -1;
        }
        .header h1 {
            color: #0f172a; /* high contrast */
            margin: 0 0 12px 0;
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 0.2px;
        }
        .project-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .info-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.4) 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .info-card strong {
            color: var(--primary-600);
            font-weight: 600;
        }
        .summary-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.8) 100%);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }
        .summary-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            padding: 2px;
            background: linear-gradient(135deg, var(--success-300), var(--warning-300), var(--accent-300));
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            -webkit-mask-composite: xor;
            z-index: -1;
        }
        .summary-section h2 {
            color: #111827; /* solid heading for readability */
            margin-top: 0;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            font-size: 1.4rem;
            font-weight: 700;
        }
        .fans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(520px, 1fr)); /* wider cards for readability */
            gap: 20px;
            margin-top: 24px;
        }
        .fan-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.8) 100%);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            transition: all 0.3s ease;
        }
        .fan-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            padding: 2px;
            background: linear-gradient(135deg, var(--primary-300), var(--secondary-300), var(--accent-300));
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            -webkit-mask-composite: xor;
            z-index: -1;
        }
        .fan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        .fan-card h3 {
            margin-top: 0;
            color: #0f172a;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 12px;
        }
        .fan-card.added::before {
            background: linear-gradient(135deg, var(--success-300), var(--success-400), var(--success-500));
        }
        .fan-card.draft::before {
            background: linear-gradient(135deg, var(--warning-300), var(--warning-400), var(--warning-500));
        }
        .compact-specs {
            margin-bottom: 20px;
        }
        
        .spec-row {
            display: grid;
            grid-template-columns: repeat(8, auto);
            column-gap: 8px;
            row-gap: 6px;
            margin-bottom: 6px;
            padding: 6px 8px;
            background: #ffffff;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .spec-row .spec-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .spec-row .spec-value {
            font-size: 13px;
            color: #111827;
            font-weight: 600;
            margin-right: 12px;
        }
        .spec-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.4) 100%);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .spec-label {
            font-size: 0.85rem;
            color: var(--gray-600);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .spec-value {
            font-size: 1.1rem;
            color: var(--primary-600);
            font-weight: 600;
            margin-top: 4px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 12px 0 8px;
        }
        .metric-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.5) 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .metric-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 4px;
        }
        .metric-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: #111827;
        }
        .cost-breakdown {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255,255,255,0.3);
        }
        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .cost-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--success-600);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid var(--success-300);
        }
        .total-cost {
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #ddd;
        }
        
        .detailed-section {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.2) 100%);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .detailed-section h4 {
            background: linear-gradient(135deg, var(--accent-600) 0%, var(--success-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.4) 100%);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        
        .detail-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .detail-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 1rem;
            color: var(--primary-600);
            font-weight: 600;
        }
        
        .no-data {
            text-align: center;
            color: var(--gray-500);
            font-style: italic;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 8px;
            border: 1px dashed rgba(255,255,255,0.3);
        }
        
        .compact-details {
            margin: 15px 0;
        }
        
        .detail-section {
            margin-bottom: 12px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .detail-section h5 {
            background: linear-gradient(135deg, var(--accent-600) 0%, var(--success-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .compact-detail-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .compact-detail-grid span {
            font-size: 0.85rem;
            color: var(--primary-600);
            font-weight: 500;
            padding: 4px 8px;
            background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.3) 100%);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .no-data-compact {
            font-size: 0.8rem;
            color: var(--gray-500);
            font-style: italic;
        }

        /* Bulk Margin Editor Styles */
        .bulk-margin-editor {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .bulk-margin-editor h2 {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--secondary-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .margin-editor-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto auto;
            gap: 20px;
            align-items: end;
        }

        .margin-editor-form .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 0;
        }

        .margin-editor-form label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-600);
        }

        .margin-editor-form input {
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.8);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .margin-editor-form input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: rgba(255,255,255,0.95);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-500) 0%, var(--accent-500) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        @media (max-width: 768px) {
            .margin-editor-form {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
        .project-totals {
            background-color: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .project-totals h3 {
            margin-top: 0;
            color: #333;
        }
        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .total-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .total-item h4 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        .total-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: all 0.3s ease;
            margin: 5px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        .status-added {
            background-color: #d4edda;
            color: #155724;
        }
        .status-draft {
            background-color: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Project Summary - {{ project.enquiry_number }}</h1>
            <div class="project-info">
                <div class="info-card">
                    <strong>Customer:</strong> {{ project.customer_name }}<br>
                    <strong>Sales Engineer:</strong> {{ project.sales_engineer }}
                </div>
                <div class="info-card">
                    <strong>Total Fans:</strong> {{ project.total_fans }}<br>
                    <strong>Created:</strong> {{ project.created_at }}
                </div>
                <div class="info-card">
                    <strong>Last Updated:</strong> {{ project.updated_at }}
                </div>
            </div>
        </div>

        <!-- Bulk Margin Editor -->
        <div class="section bulk-margin-editor">
            <h2>Bulk Margin Editor</h2>
            <p>Update margins for all fans in this project:</p>
            <div class="margin-editor-form">
                <div class="form-group">
                    <label for="bulk-fabrication-margin">Fabrication Margin (%)</label>
                    <input type="number" id="bulk-fabrication-margin" step="0.1" min="0" max="100" placeholder="25">
                </div>
                <div class="form-group">
                    <label for="bulk-bought-out-margin">Bought Out Margin (%)</label>
                    <input type="number" id="bulk-bought-out-margin" step="0.1" min="0" max="100" placeholder="25">
                </div>
                <button type="button" id="update-all-margins" class="btn btn-primary">Update All Fans</button>
                <button type="button" id="reset-margins" class="btn btn-secondary">Reset to Current</button>
            </div>
        </div>

        <div class="summary-section">
            <h2>Fans Overview</h2>
            <div class="fans-grid">
                {% for fan in project.fans %}
                <div class="fan-card {{ fan.status }}">
                    <h3>Fan {{ fan.fan_number }} <span class="status-badge status-{{ fan.status }}">{{ fan.status.title() }}</span></h3>

                    <!-- Compact Fan Specifications -->
                    <div class="compact-specs">
                        <div class="spec-row">
                            <span class="spec-label">Model:</span>
                            <span class="spec-value">{{ fan.specifications.get('Fan Model','-') }}</span>
                            <span class="spec-label">Size:</span>
                            <span class="spec-value">{{ fan.specifications.get('Fan Size','-') }}</span>
                            <span class="spec-label">Class:</span>
                            <span class="spec-value">{{ fan.specifications.get('Class','-') }}</span>
                            <span class="spec-label">Arr:</span>
                            <span class="spec-value">{{ fan.specifications.get('Arrangement','-') }}</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Material:</span>
                            <span class="spec-value">{{ fan.specifications.get('material','-') }}</span>
                            <span class="spec-label">Motor:</span>
                            <span class="spec-value">{{ fan.motor.get('brand','-') }} {{ fan.motor.get('kw','') }}kW</span>
                            <span class="spec-label">Pole:</span>
                            <span class="spec-value">{{ fan.motor.get('pole','-') }}</span>
                            <span class="spec-label">Eff:</span>
                            <span class="spec-value">{{ fan.motor.get('efficiency','-') }}</span>
                        </div>
                        
                        <!-- Custom Materials Detail (if material is 'others') -->
                        {% if fan.specifications.get('material') == 'others' %}
                        {% set custom_materials = [] %}
                        {% for i in range(5) %}
                            {% set name = fan.specifications.get('material_name_' ~ i) %}
                            {% set weight = fan.specifications.get('material_weight_' ~ i) %}
                            {% set rate = fan.specifications.get('material_rate_' ~ i) %}
                            {% if name and weight and rate %}
                                {% set total_cost = weight * rate %}
                                {% set _ = custom_materials.append({'name': name, 'weight': weight, 'rate': rate, 'total_cost': total_cost}) %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if custom_materials %}
                        <div class="detail-section">
                            <h5>Custom Materials</h5>
                            <div class="compact-detail-grid">
                                {% for material in custom_materials %}
                                    <span>{{ material.name }}: {{ material.weight }}kg @ ₹{{ material.rate }}/kg = ₹{{ "%.0f"|format(material.total_cost) }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                        <div class="spec-row">
                            <span class="spec-label">Motor Disc:</span>
                            <span class="spec-value">{{ fan.motor.get('discount',0) }}%</span>
                            <span class="spec-label">Bearing:</span>
                            <span class="spec-value">{{ fan.specifications.get('bearing_brand','-') }}</span>
                            <span class="spec-label">Drive Pack:</span>
                            <span class="spec-value">{{ fan.specifications.get('drive_pack','-') }}</span>
                            <span class="spec-label">Isolators:</span>
                            <span class="spec-value">{{ fan.specifications.get('vibration_isolators','-') }}</span>
                        </div>
                    </div>

                    <!-- Key Metrics Grid -->
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Total Weight</div>
                            <div class="metric-value">{{ fan.weights.get('total_weight',0) }} kg</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Cost</div>
                            <div class="metric-value">₹{{ "%.0f"|format(fan.costs.get('total_cost', 0)) }}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Selling Price</div>
                            <div class="metric-value">₹{{ "%.0f"|format(fan.costs.get('total_selling_price',0)) }}</div>
                        </div>
                    </div>

                    <!-- Compact Details Section -->
                    <div class="compact-details">
                        <div class="detail-section">
                            <h5>Weights</h5>
                            <div class="compact-detail-grid">
                                <span>Bare: {{ fan.weights.get('bare_fan_weight',0) }} kg</span>
                                <span>Accessories: {{ fan.weights.get('accessory_weight',0) }} kg</span>
                                <span>Total: {{ fan.weights.get('total_weight',0) }} kg</span>
                                <span>Isolators: {{ fan.weights.get('no_of_isolators',0) }}</span>
                                <span>Shaft: {{ fan.weights.get('shaft_diameter',0) }} mm</span>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h5>Bought Out</h5>
                            <div class="compact-detail-grid">
                                <span>Bearings: ₹{{ "%.0f"|format(fan.costs.get('bearing_price',0)) }}</span>
                                <span>Drive Pack: ₹{{ "%.0f"|format(fan.costs.get('drive_pack_price',0)) }}</span>
                                <span>Isolators: ₹{{ "%.0f"|format(fan.costs.get('vibration_isolators_price',0)) }}</span>
                                <span>Motor List: ₹{{ "%.0f"|format(fan.costs.get('motor_list_price',0)) }}</span>
                                <span>Motor Net: ₹{{ "%.0f"|format(fan.costs.get('discounted_motor_price',0)) }}</span>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h5>Accessory Weights</h5>
                            {% set aw = fan.weights.get('accessory_weight_details',{}) %}
                            {% if aw %}
                            <div class="compact-detail-grid">
                                {% for name, weight in aw.items() %}
                                <span>{{ name }}: {{ weight }} kg</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <span class="no-data-compact">No accessories</span>
                            {% endif %}
                        </div>

                        <div class="detail-section">
                            <h5>Accessory Costs</h5>
                            {# Normalize custom/accessory fields for rendering #}
                            {% set custom_accessories = fan.specifications.custom_accessories or fan.specifications.customAccessories or {} %}
                            {% set custom_accessory_costs = fan.costs.custom_accessory_costs or fan.costs.customAccessoryCosts or {} %}
                            {% set optional_items = fan.specifications.optional_items or fan.specifications.optionalItems or {} %}
                            {# Render using custom_accessories, custom_accessory_costs, optional_items below as appropriate #}
                            {% if custom_accessory_costs %}
                            <div class="compact-detail-grid">
                                {% for name, price in custom_accessory_costs.items() %}
                                <span>{{ name }}: ₹{{ "%.0f"|format(price) }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <span class="no-data-compact">No accessory costs</span>
                            {% endif %}
                        </div>

                        <div class="detail-section">
                            <h5>Optional Items</h5>
                            {% if optional_items %}
                            <div class="compact-detail-grid">
                                {% for name, price in optional_items.items() %}
                                <span>{{ name }}: ₹{{ "%.0f"|format(price) }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <span class="no-data-compact">No optional items</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div class="cost-breakdown">
                        <h4>Cost Summary</h4>
                        <div class="cost-item">
                            <span>Fabrication Cost</span>
                            <span>₹{{ "%.2f"|format(fan.costs.get('fabrication_cost',0)) }}</span>
                        </div>
                        <div class="cost-item">
                            <span>Bought Out Cost</span>
                            <span>₹{{ "%.2f"|format(fan.costs.get('bought_out_cost',0)) }}</span>
                        </div>
                        <div class="cost-item">
                            <span>Optional Items Cost</span>
                            <span>₹{{ "%.2f"|format(fan.costs.get('optional_items_cost',0)) }}</span>
                        </div>
                        <div class="cost-item">
                            <span>Total Cost</span>
                            <span>₹{{ "%.2f"|format(fan.costs.get('total_cost', fan.costs.get('fabrication_cost',0)+fan.costs.get('bought_out_cost',0))) }}</span>
                        </div>
                        <div class="cost-item">
                            <span>Fabrication Selling Price</span>
                            <span>₹{{ "%.2f"|format(fan.costs.get('fabrication_selling_price',0)) }}</span>
                        </div>
                        <div class="cost-item">
                            <span>Bought Out Selling Price</span>
                            <span>₹{{ "%.2f"|format(fan.costs.get('bought_out_selling_price',0)) }}</span>
                        </div>
                        <div class="cost-item">
                            <span><strong>Total Selling Price</strong></span>
                            <span><strong>₹{{ "%.2f"|format(fan.costs.get('total_selling_price',0)) }}</strong></span>
                        </div>
                        <div class="cost-item">
                            <span><strong>Total Job Margin</strong></span>
                            <span><strong>{{ "%.1f"|format(fan.costs.get('total_job_margin',0)) }}%</strong></span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="summary-section">
            <h2>Project Totals</h2>
            <div class="project-totals">
                <h3>Summary</h3>
                <div class="totals-grid">
                    <div class="total-item">
                        <h4>Total Fans</h4>
                        <div class="value">{{ project.total_fans }}</div>
                    </div>
                    <div class="total-item">
                        <h4>Added to Project</h4>
                        <div class="value">{{ project.fans | selectattr('status', 'equalto', 'added') | list | length }}</div>
                    </div>
                    <div class="total-item">
                        <h4>Total Fabrication Cost</h4>
                        <div class="value">₹{{ "%.2f"|format(project.fans | sum(attribute='costs.fabrication_cost') or 0) }}</div>
                    </div>
                    <div class="total-item">
                        <h4>Total Bought Out Cost</h4>
                        <div class="value">₹{{ "%.2f"|format(project.fans | sum(attribute='costs.bought_out_cost') or 0) }}</div>
                    </div>
                    <div class="total-item">
                        <h4>Total Selling Price</h4>
                        <div class="value">₹{{ "%.2f"|format(project.fans | sum(attribute='costs.total_selling_price') or 0) }}</div>
                    </div>
                    <div class="total-item">
                        <h4>Average Margin</h4>
                        <div class="value">
                            {% set margins = project.fans | selectattr('costs.total_job_margin') | map(attribute='costs.total_job_margin') | list %}
                            {% if margins %}
                                {{ "%.1f"|format(margins | sum / margins | length) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="summary-section">
            <div class="actions">
                <a href="/enquiries/{{ project.enquiry_number }}/fans/1" class="btn btn-primary">Edit Fans</a>
                <button class="btn btn-success" onclick="exportToExcel()">Export to Excel</button>
                <a href="/" class="btn btn-secondary">New Project</a>
            </div>
        </div>
    </div>

    <!-- XLSX Library for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="{{ url_for('static', filename='js/summary.js') }}?v={{ range(1000, 9999) | random }}"></script>
    <script>
        // Initialize the summary with current data
        window.projectData = {{ project | tojson }};

        // Bulk Margin Editor Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const fabricationMarginInput = document.getElementById('bulk-fabrication-margin');
            const boughtOutMarginInput = document.getElementById('bulk-bought-out-margin');
            const updateAllButton = document.getElementById('update-all-margins');
            const resetButton = document.getElementById('reset-margins');

            // Initialize with current margins from first fan
            function initializeMargins() {
                const firstFan = window.projectData.fans[0];
                if (firstFan && firstFan.specifications) {
                    fabricationMarginInput.value = firstFan.specifications.fabrication_margin || 25;
                    boughtOutMarginInput.value = firstFan.specifications.bought_out_margin || 25;
                }
            }

            // Reset to current margins
            resetButton.addEventListener('click', function() {
                initializeMargins();
                showMessage('Margins reset to current values', 'info');
            });

            // Update all fans with new margins
            updateAllButton.addEventListener('click', async function() {
                const fabricationMargin = parseFloat(fabricationMarginInput.value);
                const boughtOutMargin = parseFloat(boughtOutMarginInput.value);

                if (isNaN(fabricationMargin) || isNaN(boughtOutMargin)) {
                    showMessage('Please enter valid margin values', 'error');
                    return;
                }

                if (fabricationMargin < 0 || fabricationMargin > 100 || boughtOutMargin < 0 || boughtOutMargin > 100) {
                    showMessage('Margins must be between 0 and 100', 'error');
                    return;
                }

                updateAllButton.disabled = true;
                updateAllButton.textContent = 'Updating...';

                try {
                    const updatePromises = window.projectData.fans.map(async (fan) => {
                        const response = await fetch(`/api/projects/${window.projectData.enquiry_number}/fans/${fan.fan_number}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                specifications: {
                                    ...fan.specifications,
                                    fabrication_margin: fabricationMargin,
                                    bought_out_margin: boughtOutMargin
                                },
                                motor: fan.motor
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`Failed to update fan ${fan.fan_number}`);
                        }

                        return response.json();
                    });

                    await Promise.all(updatePromises);
                    showMessage('All fans updated successfully! Refreshing page...', 'success');
                    
                    // Refresh the page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);

                } catch (error) {
                    console.error('Error updating margins:', error);
                    showMessage('Error updating margins: ' + error.message, 'error');
                } finally {
                    updateAllButton.disabled = false;
                    updateAllButton.textContent = 'Update All Fans';
                }
            });

            // Initialize margins on page load
            initializeMargins();
        });

        // Message display function
        function showMessage(message, type) {
            // Create or get message container
            let messageContainer = document.getElementById('message-container');
            if (!messageContainer) {
                messageContainer = document.createElement('div');
                messageContainer.id = 'message-container';
                messageContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 1000;
                    max-width: 400px;
                `;
                document.body.appendChild(messageContainer);
            }

            // Create message element
            const messageEl = document.createElement('div');
            messageEl.style.cssText = `
                padding: 12px 20px;
                margin-bottom: 10px;
                border-radius: 8px;
                font-weight: 500;
                animation: slideIn 0.3s ease;
                ${type === 'success' ? 'background: linear-gradient(135deg, #10b981, #059669); color: white;' : 
                  type === 'error' ? 'background: linear-gradient(135deg, #ef4444, #dc2626); color: white;' :
                  'background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;'}
            `;
            messageEl.textContent = message;

            messageContainer.appendChild(messageEl);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (messageEl.parentNode) {
                            messageEl.parentNode.removeChild(messageEl);
                        }
                    }, 300);
                }
            }, 4000);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>