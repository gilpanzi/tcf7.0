from flask import render_template, request, jsonify, redirect, url_for, session, flash, send_file
import logging
from database import get_db_connection, load_dropdown_options
from calculations import calculate_fan_weight, calculate_fabrication_cost, calculate_bought_out_components, ACCESSORY_NAME_MAP
import json
import os
from datetime import datetime
import sqlite3
import pandas as pd
from functools import wraps
import hashlib
import openpyxl
from openpyxl.styles import Font, PatternFill, Alignment
from openpyxl.utils import get_column_letter
from openpyxl.workbook import Workbook
from openpyxl.styles.borders import Border, Side
from openpyxl.utils.dataframe import dataframe_to_rows

logger = logging.getLogger(__name__)

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

def admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session or not session.get('is_admin'):
            flash('Admin access required')
            return redirect(url_for('index'))
        return f(*args, **kwargs)
    return decorated_function

# Run migration immediately when module is loaded
def migrate_database():
    """Migrate the database schema."""
    try:
        # Create a base directory for data and a subdirectory for the central database
        data_dir = 'data'
        central_db_dir = os.path.join(data_dir, 'central_database')
        os.makedirs(central_db_dir, exist_ok=True)
        central_db_name = os.path.join(central_db_dir, 'all_projects.db')
        
        # If the central database doesn't exist in the data directory but exists in the original location,
        # copy it to the data directory
        original_db_path = 'central_database/all_projects.db'
        if not os.path.exists(central_db_name) and os.path.exists(original_db_path):
            import shutil
            shutil.copy(original_db_path, central_db_name)
            logger.info(f"Copied central database to {central_db_name}")
        
        # Connect to the central database
        conn = sqlite3.connect(central_db_name)
        cursor = conn.cursor()
        
        # Drop and recreate ProjectFans table with all required columns
        cursor.execute("DROP TABLE IF EXISTS ProjectFans")
        
        cursor.execute('''
            CREATE TABLE ProjectFans (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                enquiry_number TEXT,
                fan_number INTEGER,
                fan_model TEXT,
                size TEXT,
                class TEXT,
                arrangement TEXT,
                vendor TEXT,
                material TEXT,
                accessories TEXT,
                bare_fan_weight REAL,
                accessory_weight REAL,
                total_weight REAL,
                fabrication_weight REAL,
                bought_out_weight REAL,
                fabrication_cost REAL,
                motor_cost REAL,
                vibration_isolators_cost REAL,
                drive_pack_cost REAL,
                bearing_cost REAL,
                optional_items_cost REAL,
                flex_connectors_cost REAL,
                bought_out_cost REAL,
                total_cost REAL,
                fabrication_selling_price REAL,
                bought_out_selling_price REAL,
                total_selling_price REAL,
                total_job_margin REAL,
                vibration_isolators TEXT,
                drive_pack_kw REAL,
                custom_accessories TEXT,
                optional_items TEXT,
                custom_option_items TEXT,
                motor_kw REAL,
                motor_brand TEXT,
                motor_pole REAL,
                motor_efficiency TEXT,
                motor_discount_rate REAL,
                bearing_brand TEXT,
                shaft_diameter REAL,
                no_of_isolators INTEGER,
                fabrication_margin REAL,
                bought_out_margin REAL,
                FOREIGN KEY (enquiry_number) REFERENCES Projects(enquiry_number)
            )
        ''')
        
        # Create indexes for better performance
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_projectfans_enquiry ON ProjectFans(enquiry_number)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_projectfans_fan_number ON ProjectFans(fan_number)')
        
        conn.commit()
        conn.close()
        logger.info("Database migration completed successfully")
        
    except Exception as e:
        logger.error(f"Error during database migration: {str(e)}")
        if 'conn' in locals():
            conn.close()

# Run migration immediately
migrate_database()

def register_routes(app):
    """Register all routes for the application."""
    
    # Run database migration first
    migrate_database()
    
    @app.route('/login', methods=['GET', 'POST'])
    def login():
        if request.method == 'POST':
            username = request.form.get('username')
            password = request.form.get('password')
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute('SELECT id, username, password, full_name, is_admin FROM users WHERE username = ?', (username,))
                user = cursor.fetchone()
                
                if user and user[2] == password:  # Simple password comparison
                    session['user_id'] = user[0]
                    session['username'] = user[1]
                    session['full_name'] = user[3]
                    session['is_admin'] = user[4]
                    return redirect(url_for('index'))
                else:
                    return render_template('login.html', error='Invalid username or password')
        
        return render_template('login.html')

    @app.route('/logout')
    def logout():
        session.clear()
        return redirect(url_for('login'))

    @app.route('/')
    @login_required
    def index():
        """Render the main page with all dropdown options."""
        try:
            options = load_dropdown_options()
            return render_template('index.html', **options)
        except Exception as e:
            logger.error(f"Error loading index page: {str(e)}")
            return "An error occurred while loading the page", 500

    @app.route('/calculate_fan', methods=['POST'])
    def calculate_fan():
        """Calculate weight and cost based on form data."""
        try:
            data = request.json
            logger.info("Calculating fan data")
            logger.info(f"Received data: {data}")
            
            fan_data = {
                'Fan Model': data['Fan_Model'],
                'Fan Size': data['Fan_Size'],
                'Class': data['Class'],
                'Arrangement': data['Arrangement'],
                'vendor': data.get('vendor', 'TCF Factory'),
                'material': data.get('material', 'ms'),
                'vibration_isolators': data.get('vibration_isolators', 'not_required'),
                'fabrication_margin': float(data.get('fabrication_margin', 25)),
                'bought_out_margin': float(data.get('bought_out_margin', 25)),
                'motor_brand': data.get('motor_brand', ''),
                'motor_kw': data.get('motor_kw', ''),
                'pole': data.get('pole', ''),
                'efficiency': data.get('efficiency', ''),
                'motor_discount': float(data.get('motor_discount', 0)),
                'drive_pack': data.get('drive_pack'),  # Add drive pack value
                'customAccessories': data.get('customAccessories', {}),  # Add custom accessories
                'optional_items': data.get('optional_items', {})  # <-- Add this line
            }
            
            # Log the drive pack value for debugging
            logger.info(f"Drive pack value from frontend: {fan_data['drive_pack']}")
            
            # Get selected accessories - handle both object and array formats
            selected_accessories = []
            if 'accessories' in data:
                if isinstance(data['accessories'], dict):
                    selected_accessories = [key for key, value in data['accessories'].items() if value]
                elif isinstance(data['accessories'], list):
                    selected_accessories = data['accessories']
            
            # Add custom material data if present
            if fan_data['material'] == 'others':
                for i in range(5):
                    weight_key = f'material_weight_{i}'
                    name_key = f'material_name_{i}'
                    rate_key = f'material_rate_{i}'
                    if weight_key in data:
                        fan_data[weight_key] = float(data[weight_key])
                    if name_key in data:
                        fan_data[name_key] = data[name_key]
                    if rate_key in data:
                        fan_data[rate_key] = float(data[rate_key])
                # Use no_of_isolators and shaft_diameter from request if present
                no_of_isolators = data.get('no_of_isolators')
                shaft_diameter = data.get('shaft_diameter')
            else:
                no_of_isolators = None
                shaft_diameter = None
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                
                # Get fan weight data
                bare_fan_weight, db_no_of_isolators, db_shaft_diameter, total_weight, fan_error, accessory_details = calculate_fan_weight(
                    cursor, fan_data, selected_accessories
                )
                # For 'others', override with user input if provided
                if fan_data['material'] == 'others':
                    if no_of_isolators is None:
                        no_of_isolators = db_no_of_isolators
                    if shaft_diameter is None:
                        shaft_diameter = db_shaft_diameter
                else:
                    no_of_isolators = db_no_of_isolators
                    shaft_diameter = db_shaft_diameter
                
                if fan_error:
                    logger.error(f"Error in fan weight calculation: {fan_error}")
                    return jsonify({'success': False, 'message': fan_error}), 400
                
                # Calculate fabrication cost
                fabrication_cost, total_weight, custom_weights, fab_error = calculate_fabrication_cost(cursor, fan_data, total_weight)
                if fab_error:
                    logger.error(f"Error in fabrication cost calculation: {fab_error}")
                    return jsonify({'success': False, 'message': fab_error}), 400

                # Calculate bought out components cost
                bought_out_result, error = calculate_bought_out_components(cursor, fan_data, no_of_isolators, shaft_diameter)
                if error:
                    logger.error(f"Error in bought out components calculation: {error}")
                    return jsonify({'success': False, 'message': error}), 400
                
                # Extract individual component costs
                bought_out_cost = bought_out_result['total_cost']
                vibration_isolators_price = bought_out_result['vibration_isolators_price']
                bearing_price = bought_out_result['bearing_price']
                drive_pack_price = bought_out_result['drive_pack_price']
                motor_list_price = bought_out_result['motor_list_price']
                motor_discount = bought_out_result['motor_discount']
                discounted_motor_price = bought_out_result['discounted_motor_price']
                
                # Add optional items to bought out cost
                optional_items_cost = 0
                optional_items_detail = {}
                
                # Process optional items from request
                if 'optional_items' in fan_data:
                    for item_name, item_price in fan_data['optional_items'].items():
                        if item_price and float(item_price) > 0:
                            optional_items_cost += float(item_price)
                            optional_items_detail[item_name] = float(item_price)
                
                # Add optional items cost to bought out cost
                bought_out_cost += optional_items_cost
                
                # Calculate total costs and margins
                fabrication_selling_price = fabrication_cost * (1 + fan_data['fabrication_margin'] / 100)
                bought_out_selling_price = bought_out_cost * (1 + fan_data['bought_out_margin'] / 100)
                total_selling_price = fabrication_selling_price + bought_out_selling_price + optional_items_cost
                
                # Calculate total job margin
                total_raw_cost = fabrication_cost + bought_out_cost
                if total_raw_cost > 0:
                    total_job_margin = ((total_selling_price - total_raw_cost) / total_raw_cost * 100)
                else:
                    total_job_margin = 0
                
                # Calculate standard accessories weight
                standard_accessory_weight = sum(weight for name, weight in accessory_details.items() 
                                             if name in ACCESSORY_NAME_MAP.values())
                
                # Calculate custom accessories weight
                custom_accessory_weight = sum(weight for name, weight in accessory_details.items() 
                                           if name not in ACCESSORY_NAME_MAP.values())
                
                # Prepare response data
                response_data = {
                    'success': True,
                    'bare_fan_weight': bare_fan_weight,
                    'accessory_weights': standard_accessory_weight + custom_accessory_weight,
                    'total_weight': total_weight,
                    'fabrication_cost': fabrication_cost,
                    'bought_out_cost': bought_out_cost,
                    'optional_items_cost': optional_items_cost,
                    'optional_items_detail': optional_items_detail,
                    'total_raw_cost': total_raw_cost,
                    'fabrication_selling_price': fabrication_selling_price,
                    'bought_out_selling_price': bought_out_selling_price,
                    'total_selling_price': total_selling_price,
                    'total_job_margin': total_job_margin,
                    'custom_accessories': {
                        'weights': {name: weight for name, weight in accessory_details.items() 
                                  if name not in ACCESSORY_NAME_MAP.values()}
                    },
                    # Add individual bought-out component prices
                    'vibration_isolators_price': vibration_isolators_price,
                    'bearing_price': bearing_price,
                    'drive_pack_price': drive_pack_price,
                    'motor_list_price': motor_list_price,
                    'discounted_motor_price': discounted_motor_price,
                    'motor_discount': motor_discount,
                    'no_of_isolators': no_of_isolators,
                    'shaft_diameter': shaft_diameter
                }
                
                logger.info(f"Calculation response: {response_data}")
                return jsonify(response_data)
                
        except Exception as e:
            logger.error(f"Error in calculate_fan: {str(e)}", exc_info=True)
            return jsonify({'success': False, 'message': str(e)}), 500

    @app.route('/add_fan_model', methods=['POST'])
    def add_fan_model():
        """Add a new fan model to the database."""
        data = request.json
        logger.info(f"Adding new fan model: {data}")

        # Validate mandatory fields
        if not all(key in data for key in ['new_fan_model', 'new_fan_size', 'new_class', 'new_arrangement', 'new_bare_fan_weight']):
            logger.error("Missing mandatory fields for new fan model")
            return jsonify({'success': False, 'message': 'Missing mandatory fields.'})

        # Validate Shaft Diameter for non-Arrangement 4
        if data['new_arrangement'] != '4' and 'new_shaft_diameter' not in data:
            logger.error("Shaft Diameter is mandatory for non-Arrangement 4")
            return jsonify({'success': False, 'message': 'Shaft Diameter is mandatory for arrangements other than 4.'})

        # Prepare data for insertion
        fan_data = {
            'fan_model': data['new_fan_model'],
            'fan_size': data['new_fan_size'],
            'class_': data['new_class'],
            'arrangement': data['new_arrangement'],
            'bare_fan_weight': float(data['new_bare_fan_weight']),
            'shaft_diameter': float(data.get('new_shaft_diameter', 0)) if data['new_arrangement'] != '4' else None,
            'no_of_isolators': int(data.get('new_no_of_isolators', 0)) if data.get('new_no_of_isolators') else 0,
            'accessories': data.get('new_accessories', {})
        }

        # Insert into the database
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                
                # Check if this combination already exists
                cursor.execute('''
                    SELECT COUNT(*) FROM FanWeights 
                    WHERE "Fan Model" = ? AND "Fan Size" = ? AND "Class" = ? AND "Arrangement" = ?
                ''', (
                    fan_data['fan_model'], 
                    fan_data['fan_size'], 
                    fan_data['class_'], 
                    fan_data['arrangement']
                ))
                
                exists = cursor.fetchone()[0] > 0
                
                if exists:
                    # Update existing entry
                    logger.info(f"Updating existing fan model: {fan_data['fan_model']}/{fan_data['fan_size']}/{fan_data['class_']}/{fan_data['arrangement']}")
                    cursor.execute('''
                        UPDATE FanWeights SET 
                        "Bare Fan Weight" = ?, 
                        "Shaft Diameter" = ?,
                        "No. of Isolators" = ?,
                        "Unitary Base Frame" = ?,
                        "Isolation Base Frame" = ?,
                        "Split Casing" = ?,
                        "Inlet Companion Flange" = ?,
                        "Outlet Companion Flange" = ?,
                        "Inlet Butterfly Damper" = ?
                        WHERE "Fan Model" = ? AND "Fan Size" = ? AND "Class" = ? AND "Arrangement" = ?
                    ''', (
                        fan_data['bare_fan_weight'], 
                        fan_data['shaft_diameter'],
                        fan_data['no_of_isolators'],
                        fan_data['accessories'].get('Unitary Base Frame', 0),
                        fan_data['accessories'].get('Isolation Base Frame', 0),
                        fan_data['accessories'].get('Split Casing', 0),
                        fan_data['accessories'].get('Inlet Companion Flange', 0),
                        fan_data['accessories'].get('Outlet Companion Flange', 0),
                        fan_data['accessories'].get('Inlet Butterfly Damper', 0),
                        fan_data['fan_model'], 
                        fan_data['fan_size'], 
                        fan_data['class_'], 
                        fan_data['arrangement']
                    ))
                    
                    message = 'Fan model updated successfully!'
                else:
                    # Insert new entry
                    logger.info(f"Inserting new fan model: {fan_data['fan_model']}/{fan_data['fan_size']}/{fan_data['class_']}/{fan_data['arrangement']}")
                    cursor.execute('''
                        INSERT INTO FanWeights (
                            "Fan Model", "Fan Size", "Class", "Arrangement", "Bare Fan Weight", "Shaft Diameter",
                            "No. of Isolators", "Unitary Base Frame", "Isolation Base Frame", "Split Casing", 
                            "Inlet Companion Flange", "Outlet Companion Flange", "Inlet Butterfly Damper"
                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    ''', (
                        fan_data['fan_model'], 
                        fan_data['fan_size'], 
                        fan_data['class_'], 
                        fan_data['arrangement'],
                        fan_data['bare_fan_weight'], 
                        fan_data['shaft_diameter'],
                        fan_data['no_of_isolators'],
                        fan_data['accessories'].get('Unitary Base Frame', 0),
                        fan_data['accessories'].get('Isolation Base Frame', 0),
                        fan_data['accessories'].get('Split Casing', 0),
                        fan_data['accessories'].get('Inlet Companion Flange', 0),
                        fan_data['accessories'].get('Outlet Companion Flange', 0),
                        fan_data['accessories'].get('Inlet Butterfly Damper', 0)
                    ))
                    
                    message = 'New fan model added successfully!'
                
                conn.commit()
                logger.info(message)
                return jsonify({'success': True, 'message': message})
                
        except Exception as e:
            logger.error(f"Error adding/updating fan model: {str(e)}", exc_info=True)
            return jsonify({'success': False, 'message': f'Error with fan model: {str(e)}'})

    @app.route('/get_motor_options')
    def get_motor_options():
        """Get all available motor kW values."""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute('SELECT DISTINCT "Motor kW" FROM MotorPrices ORDER BY CAST("Motor kW" AS FLOAT)')
            options = [str(row[0]) for row in cursor.fetchall()]
            conn.close()
            return jsonify(options)
        except Exception as e:
            logger.error(f"Error getting motor options: {str(e)}")
            return jsonify({"error": str(e)}), 500

    @app.route('/get_pole_options/<motor_kw>')
    def get_pole_options(motor_kw):
        """Get available pole options for a given motor kW."""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute('SELECT DISTINCT Pole FROM MotorPrices WHERE "Motor kW" = ? ORDER BY Pole', (motor_kw,))
            options = [str(row[0]) for row in cursor.fetchall()]
            conn.close()
            return jsonify(options)
        except Exception as e:
            logger.error(f"Error getting pole options: {str(e)}")
            return jsonify({"error": str(e)}), 500

    @app.route('/get_efficiency_options/<motor_kw>/<pole>')
    def get_efficiency_options(motor_kw, pole):
        """Get available efficiency options for a given motor kW and pole."""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute(
                'SELECT DISTINCT Efficiency FROM MotorPrices WHERE "Motor kW" = ? AND Pole = ? ORDER BY Efficiency',
                (motor_kw, pole)
            )
            options = [str(row[0]) for row in cursor.fetchall()]
            conn.close()
            return jsonify(options)
        except Exception as e:
            logger.error(f"Error getting efficiency options: {str(e)}")
            return jsonify({"error": str(e)}), 500

    @app.route('/get_accessory_weight', methods=['POST'])
    def get_accessory_weight():
        """Get weight for a specific accessory."""
        try:
            data = request.json
            logger.info(f"Getting accessory weight for: {data}")
            
            # First check session for custom/manual weight
            session_key = f"accessory_weight_{data['fan_model']}_{data['fan_size']}_{data['class_']}_{data['arrangement']}_{data['accessory']}"
            if session_key in session:
                return jsonify({
                    'success': True,
                    'weight': session[session_key],
                    'source': 'session'
                })
            
            # If not in session, check database for standard weight
            with get_db_connection() as conn:
                cursor = conn.cursor()
                
                # Map frontend accessory name to database column name
                db_column = ACCESSORY_NAME_MAP.get(data['accessory'])
                if not db_column:
                    return jsonify({
                        'success': False, 
                        'error': f'Invalid accessory type: {data["accessory"]}'
                    })
                
                cursor.execute(f'''
                    SELECT "{db_column}"
                    FROM FanWeights
                    WHERE "Fan Model" = ? AND "Fan Size" = ? AND "Class" = ? AND "Arrangement" = ?
                ''', (
                    data['fan_model'],
                    data['fan_size'],
                    data['class_'],
                    data['arrangement']
                ))
                
                result = cursor.fetchone()
                if not result or result[0] is None:
                    return jsonify({
                        'success': False, 
                        'error': 'No accessory weight found'
                    })
                
                return jsonify({
                    'success': True,
                    'weight': result[0],
                    'source': 'database'
                })
                
        except Exception as e:
            logger.error(f"Error getting accessory weight: {str(e)}", exc_info=True)
            return jsonify({'success': False, 'error': str(e)})

    @app.route('/save_accessory_weight', methods=['POST'])
    def save_accessory_weight():
        try:
            data = request.get_json()
            logger.info(f"Received accessory weight data: {data}")
            
            fan_model = data.get('fan_model')
            fan_size = data.get('fan_size')
            class_ = data.get('class') or data.get('class_')  # Handle both class and class_
            arrangement = data.get('arrangement')
            accessory = data.get('accessory')
            weight = data.get('weight')

            if not all([fan_model, fan_size, class_, arrangement, accessory, weight]):
                return jsonify({
                    'success': False,
                    'message': 'Missing required fields'
                }), 400

            # Map frontend accessory name to database column name
            accessory_column = ACCESSORY_NAME_MAP.get(accessory, accessory)
            
            with get_db_connection() as conn:
                cursor = conn.cursor()
                
                # Check if column exists in FanWeights table
                cursor.execute("PRAGMA table_info(FanWeights)")
                columns = [col[1] for col in cursor.fetchall()]
                if accessory_column not in columns:
                    return jsonify({
                        'success': False,
                        'message': f'Column {accessory_column} does not exist in FanWeights table'
                    }), 400

                # Update the accessory weight in the existing row
                cursor.execute(f"""
                    UPDATE FanWeights
                    SET "{accessory_column}" = ?
                    WHERE "Fan Model" = ? AND "Fan Size" = ? AND "Class" = ? AND "Arrangement" = ?
                """, (weight, fan_model, fan_size, class_, arrangement))

                if cursor.rowcount == 0:
                    logger.error(f"No matching fan found for: {fan_model}, {fan_size}, {class_}, {arrangement}")
                    return jsonify({
                        'success': False,
                        'message': 'No matching fan found in database'
                    }), 404
                
                conn.commit()
                logger.info(f"Successfully updated {accessory_column} weight to {weight} kg")
                
                return jsonify({
                    'success': True,
                    'message': f'Successfully saved {accessory_column} weight'
                })
                
        except Exception as e:
            logger.error(f"Error saving accessory weight: {str(e)}", exc_info=True)
            return jsonify({
                'success': False,
                'message': f'Error saving accessory weight: {str(e)}'
            }), 500

    @app.route('/get_available_sizes/<fan_model>')
    def get_available_sizes(fan_model):
        """Get available sizes for a given fan model."""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute('''
                SELECT DISTINCT "Fan Size"
                FROM FanWeights
                WHERE "Fan Model" = ?
                ORDER BY CAST("Fan Size" AS INTEGER)
            ''', (fan_model,))
            sizes = [str(row[0]) for row in cursor.fetchall()]
            logger.debug(f"Retrieved sizes for fan model {fan_model}: {sizes}")
            return jsonify({'sizes': sizes})
        except Exception as e:
            logger.error(f"Error getting available sizes for {fan_model}: {str(e)}")
            return jsonify({'error': str(e)}), 500
        finally:
            if conn:
                conn.close()

    @app.route('/get_available_classes/<fan_model>/<fan_size>')
    def get_available_classes(fan_model, fan_size):
        """Get available classes for a given fan model and size."""
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT DISTINCT "Class"
                FROM FanWeights
                WHERE "Fan Model" = ? AND "Fan Size" = ?
                ORDER BY "Class"
            ''', (fan_model, fan_size))
            classes = [row[0] for row in cursor.fetchall()]
            return jsonify({'classes': classes})

    @app.route('/get_available_arrangements/<fan_model>/<fan_size>/<class_>')
    def get_available_arrangements(fan_model, fan_size, class_):
        """Get available arrangements for a given fan model, size, and class."""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute('''
                SELECT DISTINCT "Arrangement"
                FROM FanWeights
                WHERE "Fan Model" = ? AND "Fan Size" = ? AND "Class" = ?
                ORDER BY "Arrangement"
            ''', (fan_model, fan_size, class_))
            arrangements = [str(row[0]) for row in cursor.fetchall()]
            conn.close()
            return jsonify({"arrangements": arrangements})
        except Exception as e:
            logger.error(f"Error getting available arrangements: {str(e)}")
            return jsonify({"error": str(e)}), 500
            
    @app.route('/get_bearing_data/<fan_model>/<fan_size>/<class_>/<arrangement>/<bearing_brand>')
    def get_bearing_data(fan_model, fan_size, class_, arrangement, bearing_brand):
        """Get bearing data based on fan details and bearing brand."""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            
            # First, get the shaft diameter from the fan specifications
            cursor.execute('''
                SELECT "Shaft Diameter"
                FROM FanWeights
                WHERE "Fan Model" = ? AND "Fan Size" = ? AND "Class" = ? AND "Arrangement" = ?
            ''', (fan_model, fan_size, class_, arrangement))
            
            result = cursor.fetchone()
            if not result or result[0] is None:
                conn.close()
                return jsonify({
                    "success": False,
                    "message": f"No shaft diameter found for the specified fan configuration"
                })
            
            shaft_diameter = result[0]
            logger.info(f"Found shaft diameter {shaft_diameter} for {fan_model}/{fan_size}/{class_}/{arrangement}")
            
            # Now, get the bearing details from BearingLookup
            cursor.execute('''
                SELECT Brand, ShaftDiameter, Description, Bearing, PlummerBlock, Sleeve, Total
                FROM BearingLookup
                WHERE Brand = ? AND ShaftDiameter = ?
            ''', (bearing_brand, shaft_diameter))
            
            bearing_result = cursor.fetchone()
            
            # If no exact match, find the next suitable size
            if not bearing_result:
                cursor.execute('''
                    SELECT Brand, ShaftDiameter, Description, Bearing, PlummerBlock, Sleeve, Total
                    FROM BearingLookup
                    WHERE Brand = ? AND ShaftDiameter > ?
                    ORDER BY ShaftDiameter ASC
                    LIMIT 1
                ''', (bearing_brand, shaft_diameter))
                bearing_result = cursor.fetchone()
                if bearing_result:
                    logger.info(f"No exact match found for shaft diameter {shaft_diameter}, using next available size: {bearing_result[1]}")
            
            conn.close()
            
            if not bearing_result:
                return jsonify({
                    "success": False,
                    "message": f"No bearing found for brand {bearing_brand} and shaft diameter {shaft_diameter}"
                })
            
            # Return the bearing data
            return jsonify({
                "success": True,
                "shaft_diameter": shaft_diameter,
                "bearing_diameter": bearing_result[1],
                "description": bearing_result[2],
                "bearing_cost": bearing_result[3],
                "plummer_block_cost": bearing_result[4],
                "sleeve_cost": bearing_result[5],
                "price": bearing_result[6]
            })
            
        except Exception as e:
            logger.error(f"Error getting bearing data: {str(e)}")
            return jsonify({"success": False, "message": str(e)}), 500

    @app.route('/calculate_motor_price', methods=['POST'])
    def calculate_motor_price():
        """Calculate motor price based on specifications."""
        try:
            data = request.json
            if not all(key in data for key in ['motor_kw', 'pole', 'brand', 'efficiency']):
                return jsonify({
                    'success': False,
                    'message': 'Missing required fields'
                }), 400

            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute('''
                SELECT Price 
                FROM MotorPrices 
                WHERE "Motor kW" = ? AND Pole = ? AND Brand = ? AND Efficiency = ?
            ''', (data['motor_kw'], data['pole'], data['brand'], data['efficiency']))
            
            result = cursor.fetchone()
            conn.close()

            if result:
                return jsonify({
                    'success': True,
                    'price': float(result[0])
                })
            else:
                return jsonify({
                    'success': False,
                    'message': 'No price found for the specified configuration'
                }), 404

        except Exception as e:
            logger.error(f"Error calculating motor price: {str(e)}")
            return jsonify({
                'success': False,
                'message': str(e)
            }), 500

    @app.route('/add_fan_to_project', methods=['POST'])
    def add_fan_to_project():
        """Add a fan to a project."""
        try:
            data = request.json
            logger.info(f"Adding fan to project: {data}")
            
            # Check if we're editing an existing fan
            editing_fan_index = session.get('editing_fan_index')
            
            # Validate required fields
            required_fields = ['enquiry_number', 'customer_name', 'total_fans', 'current_fan_number']
            for field in required_fields:
                if field not in data:
                    logger.error(f"Missing required field: {field}")
                    return jsonify({
                        'success': False,
                        'message': f'Missing required field: {field}'
                    }), 400
            
            # Basic project data
            enquiry_number = data['enquiry_number']
            customer_name = data['customer_name']
            total_fans = int(data['total_fans'])
            current_fan_number = int(data['current_fan_number'])
            sales_engineer = data.get('sales_engineer', 'N/A')
            
            # Fan specific data with proper structure
            fan_data = {
                'fan_number': current_fan_number,
                'enquiry_number': enquiry_number,
                'fan_model': data.get('fan_model', ''),
                'fan_size': data.get('fan_size', ''),
                'class_': data.get('class', ''),
                'arrangement': data.get('arrangement', ''),
                'vendor': data.get('vendor', 'TCF Factory'),
                'material': data.get('material', 'ms'),
                'bare_fan_weight': float(data.get('bare_fan_weight', 0) or 0),
                'accessory_weights': float(data.get('accessory_weights', 0) or 0),
                'total_weight': float(data.get('total_weight', 0) or 0),
                'fabrication_weight': float(data.get('fabrication_weight', 0) or 0),
                'bought_out_weight': float(data.get('bought_out_weight', 0) or 0),
                'fabrication_cost': float(data.get('fabrication_cost', 0) or 0),
                'motor_cost': float(data.get('motor_cost', data.get('discounted_motor_price', 0)) or 0),
                'vibration_isolators_cost': float(data.get('vibration_isolators_cost', data.get('vibration_isolators_price', 0)) or 0),
                'drive_pack_cost': float(data.get('drive_pack_cost', data.get('drive_pack_price', 0)) or 0),
                'bearing_cost': float(data.get('bearing_cost', data.get('bearing_price', 0)) or 0),
                'optional_items_cost': float(data.get('optional_items_cost', 0) or 0),
                'flex_connectors_cost': float(data.get('flex_connectors_cost', 0) or 0),
                'bought_out_cost': float(data.get('total_bought_out_cost', 0) or 0),
                'total_cost': float(data.get('total_cost', 0) or 0),
                'fabrication_selling_price': float(data.get('fabrication_selling_price', 0) or 0),
                'bought_out_selling_price': float(data.get('bought_out_selling_price', 0) or 0),
                'total_selling_price': float(data.get('total_selling_price', 0) or 0),
                'total_job_margin': float(data.get('total_job_margin', 0) or 0),
                'vibration_isolators': data.get('vibration_isolators', ''),
                'drive_pack_kw': float(data.get('drive_pack_kw', 0) or 0),
                'motor_kw': float(data.get('motor_kw', 0) or 0),
                'motor_brand': data.get('motor_brand', ''),
                'motor_pole': float(data.get('pole', 0) or 0),
                'motor_efficiency': data.get('efficiency', ''),
                'motor_discount_rate': float(data.get('motor_discount', 0) or 0),
                'bearing_brand': data.get('bearing_brand', ''),
                'shaft_diameter': float(data.get('shaft_diameter', 0) or 0)
            }
            
            # Create properly nested structure for session storage
            session_fan_data = {
                'specifications': {
                    'fan_model': fan_data['fan_model'],
                    'size': fan_data['fan_size'],
                    'class': fan_data['class_'],
                    'arrangement': fan_data['arrangement'],
                    'vendor': fan_data['vendor'],
                    'material': fan_data['material'],
                    'vibration_isolators': fan_data['vibration_isolators'],
                    'bearing_brand': fan_data['bearing_brand'],
                    'drive_pack_kw': fan_data['drive_pack_kw'],
                    'shaft_diameter': fan_data['shaft_diameter']
                },
                'weights': {
                    'bare_fan_weight': fan_data['bare_fan_weight'],
                    'accessory_weight': fan_data['accessory_weights'],
                    'total_weight': fan_data['total_weight'],
                    'fabrication_weight': fan_data['fabrication_weight'],
                    'bought_out_weight': fan_data['bought_out_weight']
                },
                'costs': {
                    'fabrication_cost': fan_data['fabrication_cost'],
                    'motor_cost': fan_data['motor_cost'],
                    'vibration_isolators_cost': fan_data['vibration_isolators_cost'],
                    'drive_pack_cost': fan_data['drive_pack_cost'],
                    'bearing_cost': fan_data['bearing_cost'],
                    'optional_items_cost': fan_data['optional_items_cost'],
                    'flex_connectors_cost': fan_data['flex_connectors_cost'],
                    'bought_out_cost': fan_data['bought_out_cost'],
                    'total_cost': fan_data['total_cost'],
                    'fabrication_selling_price': fan_data['fabrication_selling_price'],
                    'bought_out_selling_price': fan_data['bought_out_selling_price'],
                    'total_selling_price': fan_data['total_selling_price'],
                    'total_job_margin': fan_data['total_job_margin']
                },
                'motor': {
                    'brand': fan_data['motor_brand'],
                    'kw': fan_data['motor_kw'],
                    'pole': fan_data['motor_pole'],
                    'efficiency': fan_data['motor_efficiency'],
                    'discount_rate': fan_data['motor_discount_rate']
                }
            }
            
            # Process accessories
            accessories = data.get('accessories', {})
            for key in list(accessories.keys()):
                if not accessories[key]:
                    del accessories[key]
            
            session_fan_data['specifications']['accessories'] = accessories
            fan_data['accessories'] = json.dumps(accessories)
            
            # Process optional items
            optional_items = data.get('optional_items', {})
            optional_item_prices = data.get('optional_item_prices', {})
            
            # Combine optional items and their prices for storage
            optional_items_data = {
                'items': optional_items,
                'prices': optional_item_prices
            }
            
            session_fan_data['specifications']['optional_items'] = optional_items_data
            fan_data['optional_items'] = json.dumps(optional_items_data)
            
            # Process custom accessories and options
            custom_accessories = data.get('custom_accessories', {})
            session_fan_data['specifications']['custom_accessories'] = custom_accessories
            fan_data['custom_accessories'] = json.dumps(custom_accessories)
            
            custom_option_items = data.get('custom_option_items', {})
            session_fan_data['specifications']['custom_option_items'] = custom_option_items
            fan_data['custom_option_items'] = json.dumps(custom_option_items)
            
            # If editing, update the existing fan in session
            if editing_fan_index is not None and 'fans' in session and editing_fan_index < len(session['fans']):
                session['fans'][editing_fan_index] = session_fan_data
                session.pop('editing_fan_index', None)  # Clear editing flag
                session.modified = True  # Ensure session changes are saved
                logger.info(f"Updated fan {editing_fan_index} in session")
                
                # Redirect to summary after editing
                return jsonify({
                    'success': True,
                    'message': 'Fan updated successfully',
                    'project_complete': True
                })
            else:
                # Add a new fan to the session
                if 'fans' not in session:
                    session['fans'] = []
                session['fans'].append(session_fan_data)
                session.modified = True  # Ensure session changes are saved
                
                # Connect to database
                conn = get_db_connection()
                cursor = conn.cursor()
                
                # Check if project exists or create it
                cursor.execute(
                    'SELECT id FROM Projects WHERE enquiry_number = ?',
                    (enquiry_number,)
                )
                project = cursor.fetchone()
                
                if project:
                    project_id = project[0]
                    logger.info(f"Found existing project with ID: {project_id}")
                else:
                    logger.info("Creating new project")
                    cursor.execute(
                        'INSERT INTO Projects (enquiry_number, customer_name, total_fans, sales_engineer) VALUES (?, ?, ?, ?)',
                        (enquiry_number, customer_name, total_fans, sales_engineer)
                    )
                    project_id = cursor.lastrowid
                    logger.info(f"Created new project with ID: {project_id}")
                
                # Insert fan data with correct parameter count
                cursor.execute('''
                    INSERT INTO ProjectFans (
                        project_id, fan_number, fan_model, fan_size, class, arrangement, 
                        vendor, material, accessories, bare_fan_weight, accessory_weight,
                        total_weight, fabrication_cost, bought_out_cost, total_cost,
                        fabrication_selling_price, bought_out_selling_price, total_selling_price,
                        vibration_isolators, drive_pack_kw, custom_accessories, optional_items,
                        custom_option_items, motor_kw, motor_brand, motor_pole, motor_efficiency,
                        motor_discount_rate, bearing_brand, shaft_diameter, vibration_isolators_cost,
                        drive_pack_cost, bearing_cost, motor_cost, fabrication_weight, bought_out_weight,
                        optional_items_cost, flex_connectors_cost, total_job_margin,
                        no_of_isolators, fabrication_margin, bought_out_margin,
                        NULL  -- Extra parameter to match the 42 placeholders
                        no_of_isolators, fabrication_margin, bought_out_margin
                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ''', (
                    project_id,
                    current_fan_number,
                    fan_data['fan_model'],
                    fan_data['fan_size'],
                    fan_data['class_'],
                    fan_data['arrangement'],
                    fan_data['vendor'],
                    fan_data['material'],
                    fan_data['accessories'],
                    fan_data['bare_fan_weight'],
                    fan_data['accessory_weights'],
                    fan_data['total_weight'],
                    fan_data['fabrication_cost'],
                    fan_data['bought_out_cost'],
                    fan_data['total_cost'],
                    fan_data['fabrication_selling_price'],
                    fan_data['bought_out_selling_price'],
                    fan_data['total_selling_price'],
                    fan_data['vibration_isolators'],
                    fan_data['drive_pack_kw'],
                    fan_data['custom_accessories'],
                    fan_data['optional_items'],
                    fan_data['custom_option_items'],
                    fan_data['motor_kw'],
                    fan_data['motor_brand'],
                    fan_data['motor_pole'],
                    fan_data['motor_efficiency'],
                    fan_data['motor_discount_rate'],
                    fan_data['bearing_brand'],
                    fan_data['shaft_diameter'],
                    fan_data['vibration_isolators_cost'],
                    fan_data['drive_pack_cost'],
                    fan_data['bearing_cost'],
                    fan_data['motor_cost'],
                    fan_data['fabrication_weight'],
                    fan_data['bought_out_weight'],
                    fan_data['optional_items_cost'],
                    fan_data['flex_connectors_cost'],
                    fan_data['total_job_margin'],
                    fan_data['no_of_isolators'],
                    fan_data['fabrication_margin'],
                    fan_data['bought_out_margin'],
                    None  # Extra parameter for 42nd value
                ))
                
                conn.commit()
                
                # Check if all fans have been added for this project
                project_complete = current_fan_number >= total_fans
                
                return jsonify({
                    'success': True,
                    'message': 'Fan added successfully',
                    'project_complete': project_complete
                })
            
        except Exception as e:
            logger.error(f"Error adding fan to project: {str(e)}", exc_info=True)
            return jsonify({
                'success': False,
                'message': f'Error adding fan to project: {str(e)}'
            }), 500

    @app.route('/get_project_data/<enquiry_number>')
    def get_project_data(enquiry_number):
        """Get all data for a project by enquiry number."""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            
            # Get project details
            cursor.execute(
                'SELECT id, enquiry_number, customer_name, total_fans, created_at FROM Projects WHERE enquiry_number = ?',
                (enquiry_number,))
            project = cursor.fetchone()
            
            if not project:
                conn.close()
                return jsonify({
                    'success': False,
                    'message': f'No project found with enquiry number: {enquiry_number}'
                }), 404
            
            # Convert row to dictionary
            project_columns = ['id', 'enquiry_number', 'customer_name', 'total_fans', 'created_at']
            project_dict = dict(zip(project_columns, project))
            
            # Get all fans for this project
            cursor.execute('''
                SELECT * FROM ProjectFans
                WHERE enquiry_number = ?
                ORDER BY fan_number
            ''', (enquiry_number,))
            
            fans = []
            for row in cursor.fetchall():
                # Get the column names correctly
                column_names = [col[0] for col in cursor.description]
                fan_dict = dict(zip(column_names, row))
                
                # Log the raw fan data for debugging
                logger.debug(f"Raw fan data from database: {fan_dict}")
                
                # Build a proper fan structure with nested objects
                fan_data = {
                    'specifications': {
                        'fan_model': fan_dict.get('fan_model', ''),
                        'size': fan_dict.get('size', ''),
                        'class': fan_dict.get('class', ''),
                        'arrangement': fan_dict.get('arrangement', ''),
                        'vendor': fan_dict.get('vendor', ''),
                        'material': fan_dict.get('material', ''),
                        'vibration_isolators': fan_dict.get('vibration_isolators', ''),
                        'bearing_brand': fan_dict.get('bearing_brand', ''),
                        'drive_pack_kw': float(fan_dict.get('drive_pack_kw', 0) or 0),
                        'shaft_diameter': float(fan_dict.get('shaft_diameter', 0) or 0),
                        'no_of_isolators': int(fan_dict.get('no_of_isolators', 0) or 0),
                        'fabrication_margin': float(fan_dict.get('fabrication_margin', 0) or 0),
                        'bought_out_margin': float(fan_dict.get('bought_out_margin', 0) or 0),
                    },
                    'weights': {
                        'bare_fan_weight': float(fan_dict.get('bare_fan_weight', 0) or 0),
                        'accessory_weight': float(fan_dict.get('accessory_weight', 0) or 0),
                        'total_weight': float(fan_dict.get('total_weight', 0) or 0),
                        'fabrication_weight': float(fan_dict.get('fabrication_weight', 0) or 0),
                        'bought_out_weight': float(fan_dict.get('bought_out_weight', 0) or 0),
                    },
                    'costs': {
                        'fabrication_cost': float(fan_dict.get('fabrication_cost', 0) or 0),
                        'motor_cost': float(fan_dict.get('motor_cost', 0) or 0),
                        'vibration_isolators_cost': float(fan_dict.get('vibration_isolators_cost', 0) or 0),
                        'drive_pack_cost': float(fan_dict.get('drive_pack_cost', 0) or 0),
                        'bearing_cost': float(fan_dict.get('bearing_cost', 0) or 0),
                        'optional_items_cost': float(fan_dict.get('optional_items_cost', 0) or 0),
                        'flex_connectors_cost': float(fan_dict.get('flex_connectors_cost', 0) or 0),
                        'bought_out_cost': float(fan_dict.get('bought_out_cost', 0) or 0),
                        'total_cost': float(fan_dict.get('total_cost', 0) or 0),
                        'fabrication_selling_price': float(fan_dict.get('fabrication_selling_price', 0) or 0),
                        'bought_out_selling_price': float(fan_dict.get('bought_out_selling_price', 0) or 0),
                        'total_selling_price': float(fan_dict.get('total_selling_price', 0) or 0),
                        'total_job_margin': float(fan_dict.get('total_job_margin', 0) or 0),
                    },
                    'motor': {
                        'kw': float(fan_dict.get('motor_kw', 0) or 0),
                        'brand': fan_dict.get('motor_brand', ''),
                        'pole': int(float(fan_dict.get('motor_pole', 0) or 0)),
                        'efficiency': fan_dict.get('motor_efficiency', ''),
                        'discount_rate': float(fan_dict.get('motor_discount_rate', 0) or 0),
                    },
                    # Add direct access to cost fields for frontend compatibility
                    'fabrication_cost': float(fan_dict.get('fabrication_cost', 0) or 0),
                    'motor_cost': float(fan_dict.get('motor_cost', 0) or 0),
                    'vibration_isolators_cost': float(fan_dict.get('vibration_isolators_cost', 0) or 0),
                    'drive_pack_cost': float(fan_dict.get('drive_pack_cost', 0) or 0),
                    'bearing_cost': float(fan_dict.get('bearing_cost', 0) or 0),
                    'optional_items_cost': float(fan_dict.get('optional_items_cost', 0) or 0),
                    'flex_connectors_cost': float(fan_dict.get('flex_connectors_cost', 0) or 0),
                    'bought_out_cost': float(fan_dict.get('bought_out_cost', 0) or 0),
                    'total_cost': float(fan_dict.get('total_cost', 0) or 0),
                    'fabrication_selling_price': float(fan_dict.get('fabrication_selling_price', 0) or 0),
                    'bought_out_selling_price': float(fan_dict.get('bought_out_selling_price', 0) or 0),
                    'total_selling_price': float(fan_dict.get('total_selling_price', 0) or 0),
                    'total_job_margin': float(fan_dict.get('total_job_margin', 0) or 0),
                    
                    # Include additional fields to ensure correct pricing display
                    'vibration_isolators_price': float(fan_dict.get('vibration_isolators_cost', 0) or 0),
                    'bearing_price': float(fan_dict.get('bearing_cost', 0) or 0),
                    'drive_pack_price': float(fan_dict.get('drive_pack_cost', 0) or 0),
                    'discounted_motor_price': float(fan_dict.get('motor_cost', 0) or 0),
                    'total_bought_out_cost': float(fan_dict.get('bought_out_cost', 0) or 0)
                }
                
                # Parse JSON fields
                for json_field, spec_field in [
                    ('accessories', 'accessories'),
                    ('custom_accessories', 'custom_accessories'),
                    ('optional_items', 'optional_items'),
                    ('custom_option_items', 'custom_option_items')
                ]:
                    if fan_dict.get(json_field):
                        try:
                            # Parse the JSON and add to specs
                            parsed_json = json.loads(fan_dict[json_field])
                            fan_data['specifications'][spec_field] = parsed_json
                            
                            # Also add to top level for compatibility
                            fan_data[spec_field] = parsed_json
                            
                            # Handle special case for optional_items
                            if json_field == 'optional_items' and isinstance(parsed_json, dict):
                                # If it contains items and prices structure
                                if 'items' in parsed_json and 'prices' in parsed_json:
                                    fan_data['optional_items'] = parsed_json['items']
                                    fan_data['optional_item_prices'] = parsed_json['prices']
                                    
                                    # Log the optional items for debugging
                                    logger.info(f"Optional items structure: {parsed_json}")
                                    logger.info(f"Items: {parsed_json['items']}, Prices: {parsed_json['prices']}")
                                # Otherwise use the structure directly if it's just key:value pairs
                                elif not ('items' in parsed_json or 'prices' in parsed_json):
                                    fan_data['optional_items'] = parsed_json
                                    
                                    # Check if we need to extract the cost from the optional items
                                    total_optional_cost = 0
                                    for item_name, item_price in parsed_json.items():
                                        if item_price and float(item_price) > 0:
                                            total_optional_cost += float(item_price)
                                    
                                    # If we don't have optional_items_cost but calculated a value, use it
                                    if (not fan_data['optional_items_cost'] or fan_data['optional_items_cost'] == 0) and total_optional_cost > 0:
                                        fan_data['optional_items_cost'] = total_optional_cost
                                        fan_data['costs']['optional_items_cost'] = total_optional_cost
                                        logger.info(f"Extracted optional_items_cost from items: {total_optional_cost}")
                            
                        except json.JSONDecodeError as e:
                            logger.warning(f"Failed to parse JSON for {json_field}: {fan_dict.get(json_field)} - Error: {str(e)}")
                            # If it's a simple string, try to use it directly
                            if isinstance(fan_dict.get(json_field), str) and not fan_dict.get(json_field).startswith('[') and not fan_dict.get(json_field).startswith('{'):
                                fan_data['specifications'][spec_field] = [fan_dict.get(json_field)]
                                fan_data[spec_field] = [fan_dict.get(json_field)]
                            else:
                                fan_data['specifications'][spec_field] = {}
                                fan_data[spec_field] = {}
                    else:
                        fan_data['specifications'][spec_field] = {}
                        fan_data[spec_field] = {}
                
                # Log the structured fan data for debugging
                logger.debug(f"Structured fan data: {json.dumps(fan_data, default=str)}")
                
                fans.append(fan_data)
            
            conn.close()
            
            # Create project data to return
            project_data = {
                'success': True,
                'project': {
                    'enquiry_number': project[0],
                    'customer_name': project[1],
                    'total_fans': project[2],
                    'sales_engineer': project[3],
                    'created_at': project[4]
                },
                'fans': fans
            }
            
            logger.info(f"Successfully loaded project {enquiry_number} with {len(fans)} fans")
            return jsonify(project_data)
            
        except Exception as e:
            logger.error(f"Error getting project data: {str(e)}", exc_info=True)
            return jsonify({
                'success': False,
                'message': f'Error getting project data: {str(e)}'
            }), 500

    @app.route('/get_all_projects')
    def get_all_projects():
        """Get a list of all projects."""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            
            cursor.execute('''
                SELECT p.id, p.enquiry_number, p.customer_name, p.total_fans, 
                       COUNT(pf.id) as fans_added, p.created_at
                FROM Projects p
                LEFT JOIN ProjectFans pf ON p.id = pf.project_id
                GROUP BY p.id
                ORDER BY p.created_at DESC
            ''')
            
            projects_rows = cursor.fetchall()
            
            # Get column names and convert to list of dictionaries
            columns = ['id', 'enquiry_number', 'customer_name', 'total_fans', 'fans_added', 'created_at']
            projects = [dict(zip(columns, row)) for row in projects_rows]
            
            conn.close()
            return jsonify({
                'success': True,
                'projects': projects
            })
            
        except Exception as e:
            logger.error(f"Error getting all projects: {str(e)}", exc_info=True)
            return jsonify({
                'success': False,
                'message': f'Error getting all projects: {str(e)}'
            }), 500
    
    @app.route('/edit_fan/<int:fan_index>')
    def edit_fan(fan_index):
        """Edit a specific fan from the summary page."""
        try:
            # Get the fan data from session
            logger.info(f"Edit fan request received for fan index: {fan_index}")
            
            # Log session contents for debugging
            logger.info(f"Session keys: {list(session.keys())}")
            if 'fans' in session:
                logger.info(f"Number of fans in session: {len(session['fans'])}")
            else:
                logger.error("No fans found in session")
            
            if 'fans' in session and fan_index < len(session['fans']):
                fan_data = session['fans'][fan_index]
                logger.info(f"Retrieved fan data for index {fan_index}: {json.dumps(fan_data)}")
                
                # Store the fan index being edited
                session['editing_fan_index'] = fan_index
                logger.info(f"Set editing_fan_index in session to {fan_index}")
                session.modified = True  # Ensure session changes are saved
                
                # Load all dropdown options for the calculator
                options = load_dropdown_options()
                
                # Get the specific fan specifications
                fan_model = fan_data.get('specifications', {}).get('fan_model', '')
                fan_size = fan_data.get('specifications', {}).get('size', '')
                fan_class = fan_data.get('specifications', {}).get('class', '')
                motor_kw = fan_data.get('motor', {}).get('kw', '')
                motor_pole = fan_data.get('motor', {}).get('pole', '')
                
                logger.info(f"Fan specifications: model={fan_model}, size={fan_size}, class={fan_class}")
                logger.info(f"Motor specifications: kW={motor_kw}, pole={motor_pole}")
                
                # Pre-fetch dependent dropdown options for this specific fan
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    
                    # Get available sizes for this model
                    dependent_options = {}
                    if fan_model:
                        cursor.execute('''
                            SELECT DISTINCT "Fan Size" 
                            FROM FanWeights 
                            WHERE "Fan Model" = ? 
                            ORDER BY CAST("Fan Size" AS INTEGER)
                        ''', (fan_model,))
                        dependent_options['available_sizes'] = [str(row[0]) for row in cursor.fetchall()]
                        logger.info(f"Available sizes for model {fan_model}: {dependent_options['available_sizes']}")
                        
                        # Get available classes for this model and size
                        if fan_size:
                            cursor.execute('''
                                SELECT DISTINCT "Class" 
                                FROM FanWeights 
                                WHERE "Fan Model" = ? AND "Fan Size" = ? 
                                ORDER BY "Class"
                            ''', (fan_model, fan_size))
                            dependent_options['available_classes'] = [str(row[0]) for row in cursor.fetchall()]
                            logger.info(f"Available classes for model {fan_model}, size {fan_size}: {dependent_options['available_classes']}")
                            
                            # Get available arrangements for this model, size, and class
                            if fan_class:
                                cursor.execute('''
                                    SELECT DISTINCT "Arrangement" 
                                    FROM FanWeights 
                                    WHERE "Fan Model" = ? AND "Fan Size" = ? AND "Class" = ? 
                                    ORDER BY "Arrangement"
                                ''', (fan_model, fan_size, fan_class))
                                dependent_options['available_arrangements'] = [str(row[0]) for row in cursor.fetchall()]
                
                    # Get available poles for this motor kW
                    if motor_kw:
                        cursor.execute('''
                            SELECT DISTINCT Pole 
                            FROM MotorPrices 
                            WHERE "Motor kW" = ? 
                            ORDER BY Pole
                        ''', (str(motor_kw),))
                        dependent_options['available_poles'] = [str(row[0]) for row in cursor.fetchall()]
                        logger.info(f"Available poles for motor kW {motor_kw}: {dependent_options['available_poles']}")
                        
                        # Get available efficiencies for this motor kW and pole
                        if motor_pole:
                            cursor.execute('''
                                SELECT DISTINCT Efficiency 
                                FROM MotorPrices 
                                WHERE "Motor kW" = ? AND Pole = ? 
                                ORDER BY Efficiency
                            ''', (str(motor_kw), motor_pole))
                            dependent_options['available_efficiencies'] = [str(row[0]) for row in cursor.fetchall()]
                            logger.info(f"Available efficiencies: {dependent_options['available_efficiencies']}")
            
            # Ensure fan_data is properly structured for the frontend
            # Convert any numerical values to strings if needed
            if 'specifications' in fan_data:
                for key, value in fan_data['specifications'].items():
                    if isinstance(value, (int, float)):
                        fan_data['specifications'][key] = str(value)
            
            if 'motor' in fan_data:
                for key, value in fan_data['motor'].items():
                    if isinstance(value, (int, float)):
                        fan_data['motor'][key] = str(value)
            
            # Store an additional copy of data in the session for backup
            session['last_edited_fan_data'] = fan_data
            session['last_edited_dependent_options'] = dependent_options
            session.modified = True
            
            # Log what we're sending to the template
            logger.info(f"Rendering index.html with fan_data: {json.dumps(fan_data)}")
            logger.info(f"Dependent options: {json.dumps(dependent_options)}")
            
            # Render the calculator template with the fan data for editing
            return render_template('index.html', 
                                  fan_data=fan_data,
                                  editing_mode=True,
                                  fan_index=fan_index,
                                  dependent_options=dependent_options,
                                  enquiry_number=session.get('enquiry_number'),
                                  customer_name=session.get('customer_name'),
                                  total_fans=session.get('total_fans'),
                                  sales_engineer=session.get('sales_engineer'),
                                  **options)
        except Exception as e:
            logger.error(f"Error editing fan: {str(e)}", exc_info=True)
            return redirect(url_for('summary'))
            
    @app.route('/update_fan/<enquiry_number>/<int:fan_number>', methods=['POST'])
    def update_fan(enquiry_number, fan_number):
        """Update an existing fan in a project."""
        try:
            data = request.json
            logger.info(f"Updating fan {fan_number} in project {enquiry_number}")
            logger.info(f"Update data: {data}")
            
            conn = get_db_connection()
            cursor = conn.cursor()
            
            # Get project ID
            cursor.execute(
                'SELECT id FROM Projects WHERE enquiry_number = ?',
                (enquiry_number,)
            )
            project_row = cursor.fetchone()
            
            if not project_row:
                conn.close()
                return jsonify({
                    'success': False,
                    'message': f'No project found with enquiry number: {enquiry_number}'
                }), 404
                
            project_id = project_row[0]
            
            # Prepare data for update
            fan_data = {
                'fan_model': data.get('fan_model'),
                'fan_size': data.get('fan_size'),
                'class': data.get('class'),
                'arrangement': data.get('arrangement'),
                'vendor': data.get('vendor'),
                'material': data.get('material'),
                'bare_fan_weight': data.get('bare_fan_weight'),
                'accessory_weights': data.get('accessory_weights'),
                'total_weight': data.get('total_weight'),
                'fabrication_cost': data.get('fabrication_cost'),
                'bought_out_cost': data.get('bought_out_cost'),
                'total_cost': data.get('total_cost'),
                'bearing_brand': data.get('bearing_brand'),
                'shaft_diameter': data.get('shaft_diameter'),
                'motor_brand': data.get('motor_brand'),
                'motor_kw': data.get('motor_kw'),
                'pole': data.get('pole'),
                'efficiency': data.get('efficiency'),
                'accessories': json.dumps(data.get('accessories', {})),
                'optional_items': json.dumps(data.get('optional_items', {}))
            }
            
            # Only update non-None fields
            update_fields = []
            update_values = []
            
            for key, value in fan_data.items():
                if value is not None:
                    update_fields.append(f"{key} = ?")
                    update_values.append(value)
            
            if not update_fields:
                conn.close()
                return jsonify({
                    'success': False,
                    'message': 'No fields to update'
                }), 400
                
            # Add project_id and fan_number to values for WHERE clause
            update_values.append(project_id)
            update_values.append(fan_number)
            
            # Update the fan record
            cursor.execute(
                f'''
                UPDATE ProjectFans
                SET {', '.join(update_fields)}
                WHERE project_id = ? AND fan_number = ?
                ''',
                update_values
            )
            
            conn.commit()
            conn.close()
            
            return jsonify({
                'success': True,
                'message': f'Fan {fan_number} updated successfully',
                'enquiry_number': enquiry_number
            })
            
        except Exception as e:
            logger.error(f"Error updating fan: {str(e)}", exc_info=True)
            return jsonify({
                'success': False,
                'message': f'Error updating fan: {str(e)}'
            }), 500

    @app.route('/save_project_to_database/', methods=['POST'])
    @app.route('/save_project_to_database/<enquiry_number>', methods=['POST'])
    def save_project_to_database(enquiry_number=None):
        """Save project data to the central database."""
        try:
            # Create a base directory for data and a subdirectory for the central database
            data_dir = 'data'
            central_db_dir = os.path.join(data_dir, 'central_database')
            os.makedirs(central_db_dir, exist_ok=True)
            central_db_name = os.path.join(central_db_dir, 'all_projects.db')
            
            # If the central database doesn't exist in the data directory but exists in the original location,
            # copy it to the data directory
            original_db_path = 'central_database/all_projects.db'
            if not os.path.exists(central_db_name) and os.path.exists(original_db_path):
                import shutil
                shutil.copy(original_db_path, central_db_name)
                logger.info(f"Copied central database to {central_db_name}")
            
            # Connect to the central database
            conn = sqlite3.connect(central_db_name)
            cursor = conn.cursor()
            
            # Get project data from request JSON
            project_data = request.json
            
            if not project_data:
                logger.error("No project data received in request")
                return jsonify({'success': False, 'message': 'No project data received'})
            
            # If enquiry_number is not in URL, get it from the request data
            if enquiry_number is None:
                enquiry_number = project_data.get('enquiry_number')
                if not enquiry_number:
                    logger.error("No enquiry number provided")
                    return jsonify({'success': False, 'message': 'No enquiry number provided'})
            
            logger.info(f"Saving project {enquiry_number} to database")
            
            # Validate required data
            required_fields = ['customer_name', 'total_fans', 'sales_engineer', 'fans']
            for field in required_fields:
                if field not in project_data:
                    logger.error(f"Missing required field in project data: {field}")
                    return jsonify({'success': False, 'message': f'Missing required field: {field}'})
            
            # Log the received data
            logger.info(f"Received project data: enquiry_number={enquiry_number}, "
                        f"customer_name={project_data['customer_name']}, "
                        f"total_fans={project_data['total_fans']}, "
                        f"sales_engineer={project_data['sales_engineer']}, "
                        f"fans_count={len(project_data['fans'])}")
            
            fans = project_data['fans']
            if not fans:
                logger.error("No fan data found in request")
                return jsonify({'success': False, 'message': 'No fan data found in request'})
            
            # Calculate totals from the fans data
            total_weight = sum(fan.get('weights', {}).get('total_weight', 0) for fan in fans)
            total_fabrication_cost = sum(fan.get('costs', {}).get('fabrication_cost', 0) for fan in fans)
            total_bought_out_cost = sum(fan.get('costs', {}).get('bought_out_cost', 0) for fan in fans)
            total_cost = sum(fan.get('costs', {}).get('total_cost', 0) for fan in fans)
            
            # Calculate overall project margin
            if total_fabrication_cost + total_bought_out_cost > 0:
                total_job_margin = ((total_cost - (total_fabrication_cost + total_bought_out_cost)) / 
                                    (total_fabrication_cost + total_bought_out_cost) * 100)
            else:
                total_job_margin = 0
            
            project_db_data = {
                'enquiry_number': enquiry_number,
                'customer_name': project_data['customer_name'],
                'total_fans': project_data['total_fans'],
                'sales_engineer': project_data['sales_engineer'],
                'total_weight': total_weight,
                'total_fabrication_cost': total_fabrication_cost,
                'total_bought_out_cost': total_bought_out_cost,
                'total_cost': total_cost,
                'total_selling_price': total_cost,
                'total_job_margin': total_job_margin
            }
            
            try:
                # Create tables if they don't exist
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS Projects (
                        enquiry_number TEXT PRIMARY KEY,
                        customer_name TEXT,
                        total_fans INTEGER,
                        sales_engineer TEXT,
                        total_weight REAL,
                        total_fabrication_cost REAL,
                        total_bought_out_cost REAL,
                        total_cost REAL,
                        total_selling_price REAL,
                        total_job_margin REAL,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                    )
                ''')
                
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS ProjectFans (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        enquiry_number TEXT,
                        fan_number INTEGER,
                        fan_model TEXT,
                        size TEXT,
                        class TEXT,
                        arrangement TEXT,
                        vendor TEXT,
                        material TEXT,
                        accessories TEXT,
                        bare_fan_weight REAL,
                        accessory_weight REAL,
                        total_weight REAL,
                        fabrication_weight REAL,
                        bought_out_weight REAL,
                        fabrication_cost REAL,
                        motor_cost REAL,
                        vibration_isolators_cost REAL,
                        drive_pack_cost REAL,
                        bearing_cost REAL,
                        optional_items_cost REAL,
                        flex_connectors_cost REAL,
                        bought_out_cost REAL,
                        total_cost REAL,
                        fabrication_selling_price REAL,
                        bought_out_selling_price REAL,
                        total_selling_price REAL,
                        total_job_margin REAL,
                        vibration_isolators TEXT,
                        drive_pack_kw REAL,
                        custom_accessories TEXT,
                        optional_items TEXT,
                        custom_option_items TEXT,
                        motor_kw REAL,
                        motor_brand TEXT,
                        motor_pole REAL,
                        motor_efficiency TEXT,
                        motor_discount_rate REAL,
                        bearing_brand TEXT,
                        shaft_diameter REAL,
                        no_of_isolators INTEGER,
                        fabrication_margin REAL,
                        bought_out_margin REAL,
                        FOREIGN KEY (enquiry_number) REFERENCES Projects(enquiry_number)
                    )
                ''')
                
                # Check if project exists
                cursor.execute('SELECT enquiry_number FROM Projects WHERE enquiry_number = ?', (enquiry_number,))
                existing_project = cursor.fetchone()
                
                if existing_project:
                    # Update existing project
                    cursor.execute('''
                        UPDATE Projects 
                        SET customer_name = ?, total_fans = ?, sales_engineer = ?,
                            total_weight = ?, total_fabrication_cost = ?, 
                            total_bought_out_cost = ?, total_cost = ?, total_selling_price = ?, total_job_margin = ?
                        WHERE enquiry_number = ?
                    ''', (
                        project_db_data['customer_name'], project_db_data['total_fans'],
                        project_db_data['sales_engineer'], project_db_data['total_weight'],
                        project_db_data['total_fabrication_cost'], project_db_data['total_bought_out_cost'],
                        project_db_data['total_cost'], project_db_data['total_cost'], project_db_data['total_job_margin'], enquiry_number
                    ))
                    
                    # Delete existing fans
                    cursor.execute('DELETE FROM ProjectFans WHERE enquiry_number = ?', (enquiry_number,))
                    logger.info(f"Updated existing project {enquiry_number}")
                else:
                    # Insert new project
                    cursor.execute('''
                        INSERT INTO Projects (
                            enquiry_number, customer_name, total_fans, sales_engineer,
                            total_weight, total_fabrication_cost, total_bought_out_cost, 
                            total_cost, total_selling_price, total_job_margin
                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    ''', (
                        project_db_data['enquiry_number'], project_db_data['customer_name'],
                        project_db_data['total_fans'], project_db_data['sales_engineer'],
                        project_db_data['total_weight'], project_db_data['total_fabrication_cost'],
                        project_db_data['total_bought_out_cost'], project_db_data['total_cost'],
                        project_db_data['total_cost'], project_db_data['total_job_margin']
                    ))
                    logger.info(f"Inserted new project {enquiry_number}")
                
                # Insert all fans
                for i, fan in enumerate(fans, 1):
                    # Extract values with consistent field names
                    # Get specifications from nested structure
                    specs = fan.get('specifications', {})
                    weights = fan.get('weights', {})
                    costs = fan.get('costs', {})
                    motor = fan.get('motor', {})
                    
                    # Get the individual bought out costs from nested structure or top level
                    vibration_isolators_cost = costs.get('vibration_isolators_cost', 
                                               fan.get('vibration_isolators_cost', 
                                               fan.get('vibration_isolators_price', 0)))
                    
                    bearing_cost = costs.get('bearing_cost', 
                                 fan.get('bearing_cost', 
                                 fan.get('bearing_price', 0)))
                    
                    drive_pack_cost = costs.get('drive_pack_cost', 
                                    fan.get('drive_pack_cost', 
                                    fan.get('drive_pack_price', 0)))
                    
                    motor_cost = costs.get('motor_cost', 
                              fan.get('motor_cost', 
                              fan.get('discounted_motor_price', 0)))
                    
                    optional_items_cost = costs.get('optional_items_cost',
                                        fan.get('optional_items_cost', 0))
                    
                    flex_connectors_cost = costs.get('flex_connectors_cost',
                                         fan.get('flex_connectors_cost', 0))
                    
                    # Log the bought out costs for debugging
                    logger.info(f"Fan {i} bought out costs: " +
                              f"vibration_isolators_cost={vibration_isolators_cost}, " +
                              f"bearing_cost={bearing_cost}, " +
                              f"drive_pack_cost={drive_pack_cost}, " +
                              f"motor_cost={motor_cost}, " +
                              f"optional_items_cost={optional_items_cost}, " +
                              f"flex_connectors_cost={flex_connectors_cost}")
                    
                    # Format JSON fields 
                    accessories = json.dumps(specs.get('accessories', {}))
                    custom_accessories = json.dumps(specs.get('custom_accessories', {}))
                    
                    # Handle optional items - could be in different formats
                    optional_items_data = specs.get('optional_items', {})
                    
                    # If it's not a dictionary, try to get from top level
                    if not isinstance(optional_items_data, dict):
                        optional_items_data = fan.get('optional_items', {})
                    
                    # Check if we have the items/prices structure or direct key-value
                    if 'items' in optional_items_data and 'prices' in optional_items_data:
                        # Already in the right format
                        optional_items = json.dumps(optional_items_data)
                    elif fan.get('optional_items') and fan.get('optional_item_prices'):
                        # We have separate items and prices
                        optional_items = json.dumps({
                            'items': fan.get('optional_items', {}),
                            'prices': fan.get('optional_item_prices', {})
                        })
                    else:
                        # Just use what we have
                        optional_items = json.dumps(optional_items_data)
                    
                    custom_option_items = json.dumps(specs.get('custom_option_items', {}))
                    
                    # Insert fan data with consistent field names
                    cursor.execute('''
                        INSERT INTO ProjectFans (
                            enquiry_number, fan_number, fan_model, size, class, arrangement,
                            vendor, material, accessories, bare_fan_weight, accessory_weight,
                            total_weight, fabrication_weight, bought_out_weight,
                            fabrication_cost, motor_cost, vibration_isolators_cost,
                            drive_pack_cost, bearing_cost, optional_items_cost,
                            flex_connectors_cost, bought_out_cost, total_cost,
                            fabrication_selling_price, bought_out_selling_price,
                            total_selling_price, total_job_margin, vibration_isolators,
                            drive_pack_kw, custom_accessories, optional_items,
                            custom_option_items, motor_kw, motor_brand, motor_pole,
                            motor_efficiency, motor_discount_rate, bearing_brand, shaft_diameter,
                            no_of_isolators, fabrication_margin, bought_out_margin
                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    ''', (
                        enquiry_number,
                        i,  # fan_number
                        specs.get('fan_model', ''),
                        specs.get('size', ''),
                        specs.get('class', ''),
                        specs.get('arrangement', ''),
                        specs.get('vendor', ''),
                        specs.get('material', ''),
                        accessories,
                        weights.get('bare_fan_weight', 0),
                        weights.get('accessory_weight', 0),
                        weights.get('total_weight', 0),
                        weights.get('fabrication_weight', 0),
                        weights.get('bought_out_weight', 0),
                        costs.get('fabrication_cost', 0),
                        motor_cost,
                        vibration_isolators_cost,
                        drive_pack_cost,
                        bearing_cost,
                        optional_items_cost,
                        flex_connectors_cost,
                        costs.get('bought_out_cost', 0),
                        costs.get('total_cost', 0),
                        costs.get('fabrication_selling_price', 0),
                        costs.get('bought_out_selling_price', 0),
                        costs.get('total_selling_price', 0),
                        costs.get('total_job_margin', 0),
                        specs.get('vibration_isolators', ''),
                        specs.get('drive_pack_kw', 0),
                        custom_accessories,
                        optional_items,
                        custom_option_items,
                        motor.get('kw', 0),
                        motor.get('brand', ''),
                        motor.get('pole', 0),
                        motor.get('efficiency', ''),
                        motor.get('discount_rate', 0),
                        specs.get('bearing_brand', ''),
                        specs.get('shaft_diameter', 0),
                        specs.get('no_of_isolators', fan.get('no_of_isolators', 0)),
                        fan.get('fabrication_margin', costs.get('fabrication_margin', 0)),
                        fan.get('bought_out_margin', costs.get('bought_out_margin', 0)),
                        datetime.now().strftime('%Y-%m-%d %H:%M:%S')  # created_at
                    ))
                    logger.info(f"Inserted fan {i} for project {enquiry_number}")
                
                conn.commit()
                logger.info(f"Successfully saved project {enquiry_number} to database")
                return jsonify({'success': True, 'message': 'Project saved successfully'})
                
            except sqlite3.Error as e:
                conn.rollback()
                logger.error(f"Database error while saving project: {str(e)}")
                return jsonify({'success': False, 'message': f'Database error: {str(e)}'})
            finally:
                conn.close()
            
        except Exception as e:
            logger.error(f"Error saving project to database: {str(e)}")
            return jsonify({'success': False, 'message': str(e)})

    @app.route('/get_saved_enquiries')
    def get_saved_enquiries():
        """Get all saved enquiries from the central database."""
        try:
            # Use the data directory for the central database
            data_dir = 'data'
            central_db_path = os.path.join(data_dir, 'central_database', 'all_projects.db')
            
            # If the central database doesn't exist in either location, return empty list
            if not os.path.exists(central_db_path) and not os.path.exists('central_database/all_projects.db'):
                return jsonify({
                    'success': True,
                    'enquiries': []
                })
            
            # If the database exists in the original location but not in data dir, copy it
            if not os.path.exists(central_db_path) and os.path.exists('central_database/all_projects.db'):
                os.makedirs(os.path.dirname(central_db_path), exist_ok=True)
                import shutil
                shutil.copy('central_database/all_projects.db', central_db_path)
                logger.info(f"Copied central database to {central_db_path}")
            
            conn = sqlite3.connect(central_db_path)
            cursor = conn.cursor()
            
            cursor.execute('''
                SELECT enquiry_number, customer_name, total_fans, sales_engineer, created_at
                FROM Projects
                ORDER BY created_at DESC
            ''')
            
            enquiries = []
            for row in cursor.fetchall():
                enquiries.append({
                    'enquiry_number': row[0],
                    'customer_name': row[1],
                    'total_fans': row[2],
                    'sales_engineer': row[3],
                    'created_at': row[4]
                })
            
            conn.close()
            return jsonify({
                'success': True,
                'enquiries': enquiries
            })
            
        except Exception as e:
            logger.error(f"Error getting saved enquiries: {str(e)}", exc_info=True)
            return jsonify({
                'success': False,
                'message': f'Error getting saved enquiries: {str(e)}'
            }), 500

    @app.route('/load_enquiry/<enquiry_number>')
    def load_enquiry(enquiry_number):
        """Load a project from the central database."""
        try:
            logger.info(f"Loading enquiry {enquiry_number} from database")
            
            # Use the data directory for the central database
            data_dir = 'data'
            central_db_path = os.path.join(data_dir, 'central_database', 'all_projects.db')
            
            # If the database doesn't exist in the data directory, check the original location
            if not os.path.exists(central_db_path):
                if os.path.exists('central_database/all_projects.db'):
                    # Copy the database to the data directory
                    os.makedirs(os.path.dirname(central_db_path), exist_ok=True)
                    import shutil
                    shutil.copy('central_database/all_projects.db', central_db_path)
                    logger.info(f"Copied central database to {central_db_path}")
                else:
                    # No database found
                    logger.error(f"No central database found at either {central_db_path} or central_database/all_projects.db")
                    return jsonify({
                        'success': False,
                        'message': f'No enquiry found with number {enquiry_number}'
                    }), 404
            
            conn = sqlite3.connect(central_db_path)
            cursor = conn.cursor()
            
            # Get project details
            cursor.execute('''
                SELECT enquiry_number, customer_name, total_fans, sales_engineer, created_at
                FROM Projects
                WHERE enquiry_number = ?
            ''', (enquiry_number,))
            
            project = cursor.fetchone()
            if not project:
                logger.error(f"No project found with enquiry number: {enquiry_number}")
                conn.close()
                return jsonify({
                    'success': False,
                    'message': f'No project found with enquiry number: {enquiry_number}'
                }), 404
            
            # Log the project details
            logger.info(f"Found project: {project}")
            
            # Get all fans for this project using enquiry_number
            try:
                cursor.execute('''
                    SELECT * FROM ProjectFans
                    WHERE enquiry_number = ?
                    ORDER BY fan_number
                ''', (enquiry_number,))
            except sqlite3.Error as e:
                logger.error(f"SQL error when retrieving fans: {str(e)}")
                conn.close()
                return jsonify({
                    'success': False,
                    'message': f'Error retrieving fans: {str(e)}'
                }), 500
            
            fan_rows = cursor.fetchall()
            if not fan_rows:
                logger.warning(f"No fans found for project: {enquiry_number}")
            else:
                logger.info(f"Found {len(fan_rows)} fans for project {enquiry_number}")
                
            # Get column names
            column_names = [col[0] for col in cursor.description]
            logger.debug(f"ProjectFans columns: {column_names}")
                
            fans = []
            for row in fan_rows:
                # Create a dictionary from the row using column names
                fan_dict = dict(zip(column_names, row))
                logger.debug(f"Fan data from database: {fan_dict}")
                
                # Build a proper fan structure with nested objects
                fan_data = {
                    'specifications': {
                        'fan_model': fan_dict.get('fan_model', ''),
                        'size': fan_dict.get('size', ''),
                        'class': fan_dict.get('class', ''),
                        'arrangement': fan_dict.get('arrangement', ''),
                        'vendor': fan_dict.get('vendor', ''),
                        'material': fan_dict.get('material', ''),
                        'vibration_isolators': fan_dict.get('vibration_isolators', ''),
                        'bearing_brand': fan_dict.get('bearing_brand', ''),
                        'drive_pack_kw': float(fan_dict.get('drive_pack_kw', 0) or 0),
                        'shaft_diameter': float(fan_dict.get('shaft_diameter', 0) or 0),
                        'no_of_isolators': int(fan_dict.get('no_of_isolators', 0) or 0),
                        'fabrication_margin': float(fan_dict.get('fabrication_margin', 0) or 0),
                        'bought_out_margin': float(fan_dict.get('bought_out_margin', 0) or 0),
                    },
                    'weights': {
                        'bare_fan_weight': float(fan_dict.get('bare_fan_weight', 0) or 0),
                        'accessory_weight': float(fan_dict.get('accessory_weight', 0) or 0),
                        'total_weight': float(fan_dict.get('total_weight', 0) or 0),
                        'fabrication_weight': float(fan_dict.get('fabrication_weight', 0) or 0),
                        'bought_out_weight': float(fan_dict.get('bought_out_weight', 0) or 0),
                    },
                    'costs': {
                        'fabrication_cost': float(fan_dict.get('fabrication_cost', 0) or 0),
                        'motor_cost': float(fan_dict.get('motor_cost', 0) or 0),
                        'vibration_isolators_cost': float(fan_dict.get('vibration_isolators_cost', 0) or 0),
                        'drive_pack_cost': float(fan_dict.get('drive_pack_cost', 0) or 0),
                        'bearing_cost': float(fan_dict.get('bearing_cost', 0) or 0),
                        'optional_items_cost': float(fan_dict.get('optional_items_cost', 0) or 0),
                        'flex_connectors_cost': float(fan_dict.get('flex_connectors_cost', 0) or 0),
                        'bought_out_cost': float(fan_dict.get('bought_out_cost', 0) or 0),
                        'total_cost': float(fan_dict.get('total_cost', 0) or 0),
                        'fabrication_selling_price': float(fan_dict.get('fabrication_selling_price', 0) or 0),
                        'bought_out_selling_price': float(fan_dict.get('bought_out_selling_price', 0) or 0),
                        'total_selling_price': float(fan_dict.get('total_selling_price', 0) or 0),
                        'total_job_margin': float(fan_dict.get('total_job_margin', 0) or 0),
                    },
                    'motor': {
                        'kw': float(fan_dict.get('motor_kw', 0) or 0),
                        'brand': fan_dict.get('motor_brand', ''),
                        'pole': int(float(fan_dict.get('motor_pole', 0) or 0)),
                        'efficiency': fan_dict.get('motor_efficiency', ''),
                        'discount_rate': float(fan_dict.get('motor_discount_rate', 0) or 0),
                    }
                }
                
                # Add raw data for compatibility
                fan_data.update({
                    'fan_number': fan_dict.get('fan_number', 0),
                    'enquiry_number': fan_dict.get('enquiry_number', ''),
                    'fan_model': fan_dict.get('fan_model', ''),
                    'fan_size': fan_dict.get('size', ''),
                    'class_': fan_dict.get('class', ''),
                    'arrangement': fan_dict.get('arrangement', ''),
                    'vendor': fan_dict.get('vendor', ''),
                    'material': fan_dict.get('material', ''),
                    'vibration_isolators': fan_dict.get('vibration_isolators', ''),
                    'bare_fan_weight': float(fan_dict.get('bare_fan_weight', 0) or 0),
                    'accessory_weights': float(fan_dict.get('accessory_weight', 0) or 0),
                    'total_weight': float(fan_dict.get('total_weight', 0) or 0),
                    'fabrication_weight': float(fan_dict.get('fabrication_weight', 0) or 0),
                    'bought_out_weight': float(fan_dict.get('bought_out_weight', 0) or 0),
                    'fabrication_cost': float(fan_dict.get('fabrication_cost', 0) or 0),
                    'motor_cost': float(fan_dict.get('motor_cost', 0) or 0),
                    'vibration_isolators_cost': float(fan_dict.get('vibration_isolators_cost', 0) or 0),
                    'drive_pack_cost': float(fan_dict.get('drive_pack_cost', 0) or 0),
                    'bearing_cost': float(fan_dict.get('bearing_cost', 0) or 0),
                    'optional_items_cost': float(fan_dict.get('optional_items_cost', 0) or 0),
                    'flex_connectors_cost': float(fan_dict.get('flex_connectors_cost', 0) or 0),
                    'bought_out_cost': float(fan_dict.get('bought_out_cost', 0) or 0),
                    'total_cost': float(fan_dict.get('total_cost', 0) or 0),
                    'fabrication_selling_price': float(fan_dict.get('fabrication_selling_price', 0) or 0),
                    'bought_out_selling_price': float(fan_dict.get('bought_out_selling_price', 0) or 0),
                    'total_selling_price': float(fan_dict.get('total_selling_price', 0) or 0),
                    'total_job_margin': float(fan_dict.get('total_job_margin', 0) or 0),
                    'motor_kw': float(fan_dict.get('motor_kw', 0) or 0),
                    'motor_brand': fan_dict.get('motor_brand', ''),
                    'motor_pole': int(float(fan_dict.get('motor_pole', 0) or 0)),
                    'motor_efficiency': fan_dict.get('motor_efficiency', ''),
                    'motor_discount_rate': float(fan_dict.get('motor_discount_rate', 0) or 0),
                    'bearing_brand': fan_dict.get('bearing_brand', ''),
                    'shaft_diameter': float(fan_dict.get('shaft_diameter', 0) or 0),
                    'drive_pack_kw': float(fan_dict.get('drive_pack_kw', 0) or 0),
                    
                    # Include additional fields to ensure correct pricing display
                    'vibration_isolators_price': float(fan_dict.get('vibration_isolators_cost', 0) or 0),
                    'bearing_price': float(fan_dict.get('bearing_cost', 0) or 0),
                    'drive_pack_price': float(fan_dict.get('drive_pack_cost', 0) or 0),
                    'discounted_motor_price': float(fan_dict.get('motor_cost', 0) or 0),
                    'total_bought_out_cost': float(fan_dict.get('bought_out_cost', 0) or 0)
                })
                
                # Parse JSON fields
                for json_field, spec_field in [
                    ('accessories', 'accessories'),
                    ('custom_accessories', 'custom_accessories'),
                    ('optional_items', 'optional_items'),
                    ('custom_option_items', 'custom_option_items')
                ]:
                    if fan_dict.get(json_field):
                        try:
                            # Parse the JSON and add to specs
                            parsed_json = json.loads(fan_dict[json_field])
                            fan_data['specifications'][spec_field] = parsed_json
                            
                            # Also add to top level for compatibility
                            fan_data[spec_field] = parsed_json
                            
                            # Handle special case for optional_items
                            if json_field == 'optional_items' and isinstance(parsed_json, dict):
                                # If it contains items and prices structure
                                if 'items' in parsed_json and 'prices' in parsed_json:
                                    fan_data['optional_items'] = parsed_json['items']
                                    fan_data['optional_item_prices'] = parsed_json['prices']
                                # Otherwise use the structure directly if it's just key:value pairs
                                elif not ('items' in parsed_json or 'prices' in parsed_json):
                                    fan_data['optional_items'] = parsed_json
                            
                        except json.JSONDecodeError as e:
                            logger.warning(f"Failed to parse JSON for {json_field}: {fan_dict.get(json_field)} - Error: {str(e)}")
                            # If it's a simple string, try to use it directly
                            if isinstance(fan_dict.get(json_field), str) and not fan_dict.get(json_field).startswith('[') and not fan_dict.get(json_field).startswith('{'):
                                fan_data['specifications'][spec_field] = [fan_dict.get(json_field)]
                                fan_data[spec_field] = [fan_dict.get(json_field)]
                            else:
                                fan_data['specifications'][spec_field] = {}
                                fan_data[spec_field] = {}
                    else:
                        fan_data['specifications'][spec_field] = {}
                        fan_data[spec_field] = {}
                
                # Log reconstructed fan data for debugging
                logger.info(f"Reconstructed fan data with bought out costs: vibration_isolators_cost={fan_data['vibration_isolators_cost']}, " +
                           f"bearing_cost={fan_data['bearing_cost']}, drive_pack_cost={fan_data['drive_pack_cost']}, " +
                           f"motor_cost={fan_data['motor_cost']}, optional_items_cost={fan_data['optional_items_cost']}")
                
                # Add the fan to the list
                fans.append(fan_data)
                logger.debug(f"Processed fan #{fan_dict.get('fan_number')} - Model: {fan_data['specifications']['fan_model']}")
            
            conn.close()
            
            # Create project data to return
            project_data = {
                'success': True,
                'project': {
                    'enquiry_number': project[0],
                    'customer_name': project[1],
                    'total_fans': project[2],
                    'sales_engineer': project[3],
                    'created_at': project[4]
                },
                'fans': fans
            }
            
            logger.info(f"Successfully loaded project {enquiry_number} with {len(fans)} fans")
            return jsonify(project_data)
            
        except Exception as e:
            logger.error(f"Error loading enquiry: {str(e)}", exc_info=True)
            return jsonify({
                'success': False,
                'message': f'Error loading enquiry: {str(e)}'
            }), 500

    @app.route('/summary')
    def summary():
        """Render the project summary page."""
        try:
            # Get data from session
            enquiry_number = session.get('enquiry_number')
            customer_name = session.get('customer_name')
            total_fans = session.get('total_fans')
            fans = session.get('fans', [])
            sales_engineer = session.get('sales_engineer')
            
            # Log session data for debugging
            logger.info(f"Session data for summary: enquiry_number={enquiry_number}, "
                       f"customer_name={customer_name}, total_fans={total_fans}, "
                       f"sales_engineer={sales_engineer}, fans_count={len(fans)}")
            
            # Check if we have all required data
            if not all([enquiry_number, customer_name, total_fans, fans, sales_engineer]):
                missing_data = []
                if not enquiry_number: missing_data.append("enquiry_number")
                if not customer_name: missing_data.append("customer_name")
                if not total_fans: missing_data.append("total_fans")
                if not fans: missing_data.append("fans")
                if not sales_engineer: missing_data.append("sales_engineer")
                
                logger.error(f"Missing required session data for summary page: {', '.join(missing_data)}")
                flash("Missing required data for summary page. Please start a new enquiry.", "error")
                return redirect(url_for('index'))
            
            # Check and fix fan data structure
            validated_fans = []
            for i, fan in enumerate(fans):
                if not isinstance(fan, dict):
                    logger.error(f"Fan {i} is not a dictionary: {type(fan)}")
                    continue
                
                # Ensure the required nested structures exist
                if 'specifications' not in fan:
                    logger.warning(f"Fan {i} is missing specifications, creating empty structure")
                    fan['specifications'] = {}
                
                if 'weights' not in fan:
                    logger.warning(f"Fan {i} is missing weights, creating empty structure")
                    fan['weights'] = {'total_weight': 0, 'bare_fan_weight': 0, 'accessory_weight': 0, 'fabrication_weight': 0, 'bought_out_weight': 0}
                
                if 'costs' not in fan:
                    logger.warning(f"Fan {i} is missing costs, creating empty structure")
                    fan['costs'] = {'fabrication_cost': 0, 'bought_out_cost': 0, 'total_cost': 0, 'fabrication_selling_price': 0, 'bought_out_selling_price': 0, 'total_selling_price': 0, 'total_job_margin': 0}
                
                if 'motor' not in fan:
                    logger.warning(f"Fan {i} is missing motor, creating empty structure")
                    fan['motor'] = {'kw': 0, 'brand': '', 'pole': 0, 'efficiency': 0, 'discount_rate': 0}
                
                # Ensure weights values are numeric
                for weight_key in ['total_weight', 'bare_fan_weight', 'accessory_weight', 'fabrication_weight', 'bought_out_weight']:
                    try:
                        fan['weights'][weight_key] = float(fan['weights'].get(weight_key, 0) or 0)
                    except (ValueError, TypeError):
                        logger.warning(f"Fan {i} has invalid {weight_key}: {fan['weights'].get(weight_key)}, defaulting to 0")
                        fan['weights'][weight_key] = 0
                
                # Ensure costs values are numeric
                for cost_key in ['fabrication_cost', 'bought_out_cost', 'total_cost', 'fabrication_selling_price', 'bought_out_selling_price', 'total_selling_price', 'total_job_margin']:
                    try:
                        fan['costs'][cost_key] = float(fan['costs'].get(cost_key, 0) or 0)
                    except (ValueError, TypeError):
                        logger.warning(f"Fan {i} has invalid {cost_key}: {fan['costs'].get(cost_key)}, defaulting to 0")
                        fan['costs'][cost_key] = 0
                
                # --- PATCH: Ensure detailed bought out costs are present ---
                # Try to get from fan['costs'] or fan directly, fallback to 0
                fan['costs']['vibration_isolators_cost'] = float(
                    fan.get('vibration_isolators_cost',
                        fan['costs'].get('vibration_isolators_cost',
                            fan.get('vibration_isolators_price',
                                fan['costs'].get('vibration_isolators_price', 0)
                            )
                        )
                    ) or 0
                )
                fan['costs']['drive_pack_cost'] = float(
                    fan.get('drive_pack_cost',
                        fan['costs'].get('drive_pack_cost',
                            fan.get('drive_pack_price',
                                fan['costs'].get('drive_pack_price', 0)
                            )
                        )
                    ) or 0
                )
                fan['costs']['bearing_cost'] = float(
                    fan.get('bearing_cost',
                        fan['costs'].get('bearing_cost',
                            fan.get('bearing_price',
                                fan['costs'].get('bearing_price', 0)
                            )
                        )
                    ) or 0
                )
                fan['costs']['motor_cost'] = float(
                    fan.get('motor_cost',
                        fan['costs'].get('motor_cost',
                            fan.get('discounted_motor_price',
                                fan['costs'].get('discounted_motor_price', 0)
                            )
                        )
                    ) or 0
                )
                # --- END PATCH ---
                
                validated_fans.append(fan)
            
            # Calculate totals with safety checks
            total_weight = sum(fan['weights'].get('total_weight', 0) or 0 for fan in validated_fans)
            total_fabrication_cost = sum(fan['costs'].get('fabrication_cost', 0) or 0 for fan in validated_fans)
            total_bought_out_cost = sum(fan['costs'].get('bought_out_cost', 0) or 0 for fan in validated_fans)
            total_cost = sum(fan['costs'].get('total_cost', 0) or 0 for fan in validated_fans)
            
            # Log the calculated totals
            logger.info(f"Calculated totals: total_weight={total_weight}, "
                       f"total_fabrication_cost={total_fabrication_cost}, "
                       f"total_bought_out_cost={total_bought_out_cost}, "
                       f"total_cost={total_cost}")
            
            return render_template('summary.html',
                enquiry_number=enquiry_number,
                customer_name=customer_name,
                total_fans=total_fans,
                fans=validated_fans,
                sales_engineer=sales_engineer,
                total_weight=total_weight,
                total_fabrication_cost=total_fabrication_cost,
                total_bought_out_cost=total_bought_out_cost,
                total_cost=total_cost
            )
        except Exception as e:
            logger.error(f"Error rendering summary page: {str(e)}", exc_info=True)
            flash("An error occurred while displaying the summary. Please try again.", "error")
            return redirect(url_for('index'))

    @app.route('/start_fan_entry', methods=['POST'])
    def start_fan_entry():
        """Store initial project data in session and start fan entry."""
        try:
            data = request.json
            logger.info(f"Starting fan entry with data: {data}")
            
            # Validate required fields
            required_fields = ['enquiry_number', 'customer_name', 'total_fans', 'sales_engineer']
            for field in required_fields:
                if not data.get(field):
                    return jsonify({
                        'success': False,
                        'message': f'Missing required field: {field}'
                    }), 400
            
            # Store data in session
            session['enquiry_number'] = data['enquiry_number']
            session['customer_name'] = data['customer_name']
            session['total_fans'] = data['total_fans']
            session['sales_engineer'] = data['sales_engineer']
            session['fans'] = []  # Initialize empty fans list
            
            # Make session permanent
            session.permanent = True
            
            return jsonify({
                'success': True,
                'message': 'Project data stored in session'
            })
            
        except Exception as e:
            logger.error(f"Error starting fan entry: {str(e)}", exc_info=True)
            return jsonify({
                'success': False,
                'message': f'Error starting fan entry: {str(e)}'
            }), 500

    @app.route('/get_session_data')
    def get_session_data():
        """Get all data stored in the session."""
        try:
            data = {
                'success': True,
                'enquiry_number': session.get('enquiry_number'),
                'customer_name': session.get('customer_name'),
                'total_fans': session.get('total_fans'),
                'sales_engineer': session.get('sales_engineer'),
                'fans': session.get('fans', [])
            }
            
            # Log the session data being returned
            logger.info(f"Returning session data: {data}")
            
            return jsonify(data)
        except Exception as e:
            logger.error(f"Error getting session data: {str(e)}", exc_info=True)
            return jsonify({
                'success': False,
                'message': f'Error getting session data: {str(e)}'
            }), 500

    @app.route('/get_fan_data/<int:fan_index>')
    def get_fan_data(fan_index):
        """Get fan data directly via AJAX."""
        try:
            logger.info(f"AJAX request for fan data at index {fan_index}")
            
            # Check if we have the fan data directly in the session
            if 'fans' in session and fan_index < len(session['fans']):
                fan_data = session['fans'][fan_index]
                logger.info(f"Found fan data in main session array")
            elif 'last_edited_fan_data' in session:
                # Fall back to the backup copy
                fan_data = session['last_edited_fan_data']
                logger.info(f"Using backup fan data from last_edited_fan_data")
            else:
                logger.error("No fan data found in session")
                return jsonify({
                    'success': False,
                    'message': 'No fan data found in session'
                })
            
            # Get dependent options
            dependent_options = {}
            if 'last_edited_dependent_options' in session:
                dependent_options = session['last_edited_dependent_options']
                logger.info("Using cached dependent options")
            else:
                # Regenerate dependent options if not available
                fan_model = fan_data.get('specifications', {}).get('fan_model', '')
                fan_size = fan_data.get('specifications', {}).get('size', '')
                fan_class = fan_data.get('specifications', {}).get('class', '')
                motor_kw = fan_data.get('motor', {}).get('kw', '')
                motor_pole = fan_data.get('motor', {}).get('pole', '')
                
                logger.info(f"Regenerating dependent options for model={fan_model}, size={fan_size}, class={fan_class}")
                
                # Pre-fetch dependent dropdown options for this specific fan
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    
                    # Get available sizes for this model
                    if fan_model:
                        cursor.execute('''
                            SELECT DISTINCT "Fan Size" 
                            FROM FanWeights 
                            WHERE "Fan Model" = ? 
                            ORDER BY CAST("Fan Size" AS INTEGER)
                        ''', (fan_model,))
                        dependent_options['available_sizes'] = [str(row[0]) for row in cursor.fetchall()]
                        
                        # Get available classes for this model and size
                        if fan_size:
                            cursor.execute('''
                                SELECT DISTINCT "Class" 
                                FROM FanWeights 
                                WHERE "Fan Model" = ? AND "Fan Size" = ? 
                                ORDER BY "Class"
                            ''', (fan_model, fan_size))
                            dependent_options['available_classes'] = [str(row[0]) for row in cursor.fetchall()]
                            
                            # Get available arrangements for this model, size, and class
                            if fan_class:
                                cursor.execute('''
                                    SELECT DISTINCT "Arrangement" 
                                    FROM FanWeights 
                                    WHERE "Fan Model" = ? AND "Fan Size" = ? AND "Class" = ? 
                                    ORDER BY "Arrangement"
                                ''', (fan_model, fan_size, fan_class))
                                dependent_options['available_arrangements'] = [str(row[0]) for row in cursor.fetchall()]
                
                    # Get available poles for this motor kW
                    if motor_kw:
                        cursor.execute('''
                            SELECT DISTINCT Pole 
                            FROM MotorPrices 
                            WHERE "Motor kW" = ? 
                            ORDER BY Pole
                        ''', (str(motor_kw),))
                        dependent_options['available_poles'] = [str(row[0]) for row in cursor.fetchall()]
                        
                        # Get available efficiencies for this motor kW and pole
                        if motor_pole:
                            cursor.execute('''
                                SELECT DISTINCT Efficiency 
                                FROM MotorPrices 
                                WHERE "Motor kW" = ? AND Pole = ? 
                                ORDER BY Efficiency
                            ''', (str(motor_kw), motor_pole))
                            dependent_options['available_efficiencies'] = [str(row[0]) for row in cursor.fetchall()]
                            logger.info(f"Available efficiencies: {dependent_options['available_efficiencies']}")
            
            # Return the data as JSON
            return jsonify({
                'success': True,
                'fan_data': fan_data,
                'dependent_options': dependent_options
            })
            
        except Exception as e:
            logger.error(f"Error retrieving fan data: {str(e)}", exc_info=True)
            return jsonify({
                'success': False,
                'message': f'Error retrieving fan data: {str(e)}'
            })

    @app.route('/save_project', methods=['POST'])
    def save_project():
        """Save project data to the database."""
        try:
            data = request.get_json()
            logger.info(f"Received data to save project: {data.keys()}")
            
            # Validate required fields
            required_fields = ['enquiry_number', 'customer_name', 'total_fans', 'fans', 'sales_engineer']
            missing_fields = [field for field in required_fields if field not in data or not data[field]]
            
            if missing_fields:
                logger.error(f"Missing required fields for saving project: {missing_fields}")
                return jsonify({'status': 'error', 'message': f"Missing required fields: {', '.join(missing_fields)}"}), 400
            
            # Extract data
            enquiry_number = data.get('enquiry_number')
            customer_name = data.get('customer_name')
            total_fans = data.get('total_fans')
            fans = data.get('fans', [])
            sales_engineer = data.get('sales_engineer')
            
            # Validate fans data
            if not isinstance(fans, list):
                logger.error(f"Fans data is not a list: {type(fans)}")
                return jsonify({'status': 'error', 'message': "Fans data must be a list"}), 400
            
            # Validate each fan object
            for i, fan in enumerate(fans):
                if not isinstance(fan, dict):
                    logger.error(f"Fan {i} is not a dictionary: {type(fan)}")
                    return jsonify({'status': 'error', 'message': f"Fan {i} has invalid format"}), 400
                
                # Ensure required fan structures exist
                for key in ['specifications', 'weights', 'costs', 'motor']:
                    if key not in fan:
                        logger.warning(f"Fan {i} is missing {key}, creating empty structure")
                        fan[key] = {}
            
            # Connect to database
            conn = get_db_connection()
            if not conn:
                logger.error("Failed to connect to database when saving project")
                return jsonify({'status': 'error', 'message': "Database connection error"}), 500
            
            cursor = conn.cursor()
            
            try:
                # Check if project already exists
                cursor.execute('SELECT id FROM projects WHERE enquiry_number = ?', (enquiry_number,))
                existing_project = cursor.fetchone()
                
                if existing_project:
                    # Update existing project
                    project_id = existing_project[0]
                    logger.info(f"Updating existing project with ID {project_id}")
                    
                    cursor.execute('''
                        UPDATE projects 
                        SET customer_name = ?, total_fans = ?, sales_engineer = ?, updated_at = CURRENT_TIMESTAMP
                        WHERE id = ?
                    ''', (customer_name, total_fans, sales_engineer, project_id))
                    
                    # Delete existing fans for this project
                    cursor.execute('DELETE FROM fans WHERE project_id = ?', (project_id,))
                else:
                    # Create new project
                    logger.info(f"Creating new project for enquiry {enquiry_number}")
                    cursor.execute('''
                        INSERT INTO projects (enquiry_number, customer_name, total_fans, sales_engineer, created_at, updated_at)
                        VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
                    ''', (enquiry_number, customer_name, total_fans, sales_engineer))
                    
                    project_id = cursor.lastrowid
                
                # Save fans data
                for i, fan in enumerate(fans):
                    specifications = json.dumps(fan.get('specifications', {}))
                    weights = json.dumps(fan.get('weights', {}))
                    costs = json.dumps(fan.get('costs', {}))
                    motor = json.dumps(fan.get('motor', {}))
                    
                    cursor.execute('''
                        INSERT INTO fans (project_id, fan_number, specifications, weights, costs, motor)
                        VALUES (?, ?, ?, ?, ?, ?)
                    ''', (project_id, i+1, specifications, weights, costs, motor))
                
                conn.commit()
                logger.info(f"Successfully saved project {enquiry_number} with {len(fans)} fans")
                
                # Save data to session
                session['enquiry_number'] = enquiry_number
                session['customer_name'] = customer_name
                session['total_fans'] = total_fans
                session['fans'] = fans
                session['sales_engineer'] = sales_engineer
                
                return jsonify({'status': 'success', 'message': "Project saved successfully"})
                
            except Exception as e:
                conn.rollback()
                logger.error(f"SQL error when saving project: {str(e)}", exc_info=True)
                return jsonify({'status': 'error', 'message': f"Database error: {str(e)}"}), 500
            finally:
                cursor.close()
                conn.close()
                
        except Exception as e:
            logger.error(f"Error saving project: {str(e)}", exc_info=True)
            return jsonify({'status': 'error', 'message': f"An error occurred: {str(e)}"}), 500

    @app.route('/load_project', methods=['POST'])
    def load_project():
        """Load project data from the database."""
        try:
            data = request.get_json()
            logger.info(f"Received request to load project: {data}")
            
            # Validate request
            if 'enquiry_number' not in data or not data['enquiry_number']:
                logger.error("Missing enquiry number for loading project")
                return jsonify({'status': 'error', 'message': "Enquiry number is required"}), 400
            
            enquiry_number = data['enquiry_number']
            
            # Connect to database
            conn = get_db_connection()
            if not conn:
                logger.error(f"Failed to connect to database when loading project {enquiry_number}")
                return jsonify({'status': 'error', 'message': "Database connection error"}), 500
            
            cursor = conn.cursor()
            
            try:
                # Get project details
                cursor.execute('''
                    SELECT id, customer_name, total_fans, sales_engineer
                    FROM projects 
                    WHERE enquiry_number = ?
                ''', (enquiry_number,))
                
                project = cursor.fetchone()
                
                if not project:
                    logger.warning(f"No project found with enquiry number {enquiry_number}")
                    return jsonify({'status': 'error', 'message': f"No project found with enquiry number {enquiry_number}"}), 404
                
                project_id, customer_name, total_fans, sales_engineer = project
                
                # Get fans data
                cursor.execute('SELECT fan_number, specifications, weights, costs, motor FROM fans WHERE project_id = ? ORDER BY fan_number', (project_id,))
                fan_rows = cursor.fetchall()
                
                if not fan_rows:
                    logger.warning(f"No fans found for project {enquiry_number}")
                    fans = []
                else:
                    fans = []
                    for fan_row in fan_rows:
                        fan_number, specifications_json, weights_json, costs_json, motor_json = fan_row
                        
                        try:
                            specifications = json.loads(specifications_json) if specifications_json else {}
                        except json.JSONDecodeError:
                            logger.error(f"Invalid JSON in specifications for fan {fan_number} in project {enquiry_number}")
                            specifications = {}
                        
                        try:
                            weights = json.loads(weights_json) if weights_json else {}
                        except json.JSONDecodeError:
                            logger.error(f"Invalid JSON in weights for fan {fan_number} in project {enquiry_number}")
                            weights = {'total_weight': 0, 'bare_fan_weight': 0, 'accessory_weight': 0, 'fabrication_weight': 0, 'bought_out_weight': 0}
                        
                        try:
                            costs = json.loads(costs_json) if costs_json else {}
                        except json.JSONDecodeError:
                            logger.error(f"Invalid JSON in costs for fan {fan_number} in project {enquiry_number}")
                            costs = {'fabrication_cost': 0, 'bought_out_cost': 0, 'total_cost': 0}
                        
                        try:
                            motor = json.loads(motor_json) if motor_json else {}
                        except json.JSONDecodeError:
                            logger.error(f"Invalid JSON in motor for fan {fan_number} in project {enquiry_number}")
                            motor = {'kw': 0, 'brand': '', 'pole': 0, 'efficiency': 0, 'discount_rate': 0}
                        
                        fan = {
                            'specifications': specifications,
                            'weights': weights,
                            'costs': costs,
                            'motor': motor
                        }
                        fans.append(fan)
                
                # Save data to session
                session['enquiry_number'] = enquiry_number
                session['customer_name'] = customer_name
                session['total_fans'] = total_fans
                session['fans'] = fans
                session['sales_engineer'] = sales_engineer
                
                logger.info(f"Successfully loaded project {enquiry_number} with {len(fans)} fans")
                
                return jsonify({
                    'status': 'success',
                    'project': {
                        'enquiry_number': enquiry_number,
                        'customer_name': customer_name,
                        'total_fans': total_fans,
                        'sales_engineer': sales_engineer,
                        'fans': fans
                    }
                })
                
            except Exception as e:
                logger.error(f"SQL error when loading project: {str(e)}", exc_info=True)
                return jsonify({'status': 'error', 'message': f"Database error: {str(e)}"}), 500
            finally:
                cursor.close()
                conn.close()
                
        except Exception as e:
            logger.error(f"Error loading project: {str(e)}", exc_info=True)
            return jsonify({'status': 'error', 'message': f"An error occurred: {str(e)}"}), 500

    # Add route to get drive pack options for the dropdown
    @app.route('/get_drive_pack_options', methods=['GET'])
    def get_drive_pack_options():
        logger.info("==== DRIVE PACK OPTIONS DEBUG ====")
        logger.info("Received request for drive pack options")
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            
            # Log available tables for debugging
            cursor.execute("SELECT name FROM sqlite_master WHERE type='table';")
            tables = cursor.fetchall()
            logger.info(f"Available tables in database: {[table[0] for table in tables]}")
            
            # Get schema for DrivePackLookup
            cursor.execute("PRAGMA table_info(DrivePackLookup);")
            columns = cursor.fetchall()
            logger.info(f"DrivePackLookup table columns: {[col[1] for col in columns]}")
            
            # Get unique Motor kW values from DrivePackLookup table
            query = 'SELECT DISTINCT "Motor kW" FROM DrivePackLookup ORDER BY "Motor kW"'
            logger.info(f"Executing query: {query}")
            cursor.execute(query)
            
            # Fetch all and log raw data
            raw_results = cursor.fetchall()
            logger.info(f"Raw query results: {raw_results}")
            
            drive_pack_options = [float(row[0]) for row in raw_results]
            
            logger.info(f"Processed drive pack options: {drive_pack_options}")
            logger.info(f"Returning {len(drive_pack_options)} drive pack options for dropdown")
            
            conn.close()
            response = {
                'success': True, 
                'options': drive_pack_options
            }
            logger.info(f"Final response: {response}")
            logger.info("==== END DRIVE PACK OPTIONS DEBUG ====")
            return jsonify(response)
        except Exception as e:
            logger.error(f"==== DRIVE PACK ERROR ====")
            logger.error(f"Error getting drive pack options: {str(e)}")
            logger.error(f"Exception details:", exc_info=True)
            logger.error(f"==== END DRIVE PACK ERROR ====")
            return jsonify({
                'success': False,
                'message': f"Error getting options: {str(e)}"
            }), 500

    @app.route('/export_project', methods=['GET', 'POST'])
    @login_required
    def export_project():
        try:
            logger.info("Starting project export")
            
            # Handle both GET and POST requests
            if request.method == 'POST':
                data = request.get_json()
                fans_data = [data]  # Single fan case
            else:  # GET request
                # Parse the fans_data from URL parameter
                fans_data = json.loads(request.args.get('fans_data', '[]'))
                if not fans_data:
                    return jsonify({'error': 'No fan data provided'}), 400

            logger.info(f"Processing {len(fans_data)} fans")

            # Helper function to clean and convert numeric values
            def clean_number(value):
                if value is None or value == '':
                    return 0
                if isinstance(value, (int, float)):
                    return float(value)
                cleaned = str(value).replace('', '').replace(',', '').replace(' ', '').replace('%', '')
                try:
                    return float(cleaned)
                except ValueError:
                    logger.error(f"Failed to convert value to float: {value}")
                    return 0

            def build_exportable_fan(fan):
                return {
                    "Fan Number": fan.get("fan_number"),
                    "Model": fan.get("model") or fan.get("fan_model", ""),
                    "Size": fan.get("size") or fan.get("fan_size", ""),
                    "Class": fan.get("class"),
                    "Arrangement": fan.get("arrangement"),
                    "Material": fan.get("material") or fan.get("moc", ""),
                    "Motor Brand": fan.get("motor_brand", ""),
                    "Motor Power": fan.get("motor_power", ""),
                    "Poles": fan.get("poles") or fan.get("pole", ""),
                    "Efficiency": fan.get("efficiency", ""),

                    "Bare Fan Weight (kg)": fan.get("fan_weight") or fan.get("bare_fan_weight", 0),
                    "Accessory Weight (kg)": fan.get("accessory_weight") or fan.get("accessory_weights", 0),
                    "Total Weight (kg)": fan.get("total_weight", 0),

                    "Fabrication Cost ()": float(fan.get("fabrication_cost", 0)),
                    "Motor Cost ()": float(fan.get("motor_cost", 0)),
                    "Vibration Isolators ()": float(fan.get("vibration_isolators_cost", 0)),
                    "Drive Pack ()": float(fan.get("drive_pack_cost", 0)),
                    "Bearing Cost ()": float(fan.get("bearing_cost", 0)),
                    "Optional Items ()": float(fan.get("optional_items_cost", 0)),
                    "Flex Connectors ()": float(fan.get("flex_connectors_cost", 0)),

                    "Total Bought Out Cost ()": float(fan.get("bought_out_cost", 0)),
                    "Total Cost ()": float(fan.get("total_cost", 0)),

                    "Fabrication Selling Price ()": float(fan.get("fabrication_selling_price", 0)),
                    "Bought Out Selling Price ()": float(fan.get("bought_out_selling_price", 0)),

                    "Total Selling Price ()": float(fan.get("total_selling_price") or
                                                 fan.get("selling_price") or
                                                 float(fan.get("fabrication_selling_price", 0)) +
                                                 float(fan.get("bought_out_selling_price", 0))),

                    "Margin (%)": float(fan.get("margin") or (
                        ((float(fan.get("total_selling_price", 0)) - float(fan.get("total_cost", 0))) / float(fan.get("total_cost", 1))) * 100
                    ))
                }

            # Debug: Log the raw fan data before transformation
            logger.info("\nDEBUG: Raw fan data before transformation:")
            logger.info(json.dumps(fans_data, indent=2, default=str))

            # Transform fans into exportable format
            export_rows = [build_exportable_fan(fan) for fan in fans_data]

            # Debug: Log the transformed data
            logger.info("\nDEBUG: Transformed fan data for export:")
            logger.info(json.dumps(export_rows, indent=2, default=str))

            # Create DataFrame and transpose
            df = pd.DataFrame(export_rows).T
            df.columns = [f"Fan {i+1}" for i in range(len(export_rows))]
            df.insert(0, "Field", df.index)
            df.reset_index(drop=True, inplace=True)

            # Add totals row
            totals = ["TOTALS"]
            for col in df.columns[1:]:
                col_total = 0
                for val in df[col]:
                    if isinstance(val, (int, float)):
                        col_total += val
                totals.append(col_total)
            df.loc[len(df)] = totals

            # Create Excel file
            filename = f"{request.args.get('enquiry_number', 'Project')}_{datetime.now().strftime('%Y%m%d')}.xlsx"
            wb = Workbook()
            ws = wb.active
            ws.title = "Fan Summary"

            # Add project details
            ws['A1'] = 'Project Details'
            ws['A2'] = f"Enquiry Number: {request.args.get('enquiry_number', '')}"
            ws['C2'] = f"Customer Name: {request.args.get('customer_name', '')}"
            ws['E2'] = f"Date: {datetime.now().strftime('%d-%m-%Y')}"

            # Write DataFrame to Excel
            for row in dataframe_to_rows(df, index=False, header=True):
                ws.append(row)

            # Style the worksheet
            bold_font = Font(bold=True)
            header_fill = PatternFill(start_color='4a90e2', end_color='4a90e2', fill_type='solid')
            header_font = Font(bold=True, color='FFFFFF')
            header_alignment = Alignment(horizontal='center')

            # Style headers and totals
            for cell in ws[5]:  # Headers row
                cell.font = header_font
                cell.fill = header_fill
                cell.alignment = header_alignment

            for cell in ws[ws.max_row]:  # Totals row
                cell.font = bold_font

            # Apply number formatting
            for row in ws.iter_rows(min_row=6, max_row=ws.max_row-1):
                for cell in row[1:]:  # Skip first column (Field names)
                    if isinstance(cell.value, (int, float)):
                        # Get the field name from column A
                        field_name = ws.cell(row=cell.row, column=1).value
                        if 'Cost' in field_name or 'Price' in field_name:
                            cell.number_format = '#,##0.00'
                        elif 'Weight' in field_name:
                            cell.number_format = '#,##0.00" kg"'
                        elif 'Margin' in field_name:
                            cell.number_format = '#,##0.00"%"'
                        else:
                            cell.number_format = '#,##0.00'

            # Add borders
            thin_border = Border(
                left=Side(style='thin'),
                right=Side(style='thin'),
                top=Side(style='thin'),
                bottom=Side(style='thin')
            )
            for row in ws.iter_rows(min_row=5, max_row=ws.max_row):
                for cell in row:
                    cell.border = thin_border

            # Auto-fit column widths
            for column in ws.columns:
                max_length = 0
                column = list(column)
                for cell in column:
                    try:
                        if len(str(cell.value)) > max_length:
                            max_length = len(str(cell.value))
                    except:
                        pass
                adjusted_width = (max_length + 2)
                ws.column_dimensions[column[0].column_letter].width = adjusted_width

            # Save the file
            wb.save(filename)
            
            logger.info(f"Excel file created successfully: {filename}")
            
            # Send the file
            return send_file(
                filename,
                as_attachment=True,
                download_name=filename,
                mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            )
                
        except Exception as e:
            logger.error(f"Error exporting project: {str(e)}", exc_info=True)
            return jsonify({'error': str(e)}), 500

    @app.route('/get_project_id/<enquiry_number>')
    @login_required
    def get_project_id(enquiry_number):
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute('SELECT id FROM projects WHERE enquiry_number = ?', (enquiry_number,))
                project = cursor.fetchone()
                
                if project:
                    return jsonify({'project_id': project[0]})
                else:
                    return jsonify({'project_id': None}), 404
                    
        except Exception as e:
            logger.error(f"Error getting project ID: {str(e)}")
            return jsonify({'error': str(e)}), 500

    @app.route('/export_summary_excel', methods=['GET'])
    @login_required
    def export_summary_excel():
        """Export project summary to Excel, matching the UI structure with breakdowns and correct totals, including all custom fields."""
        try:
            enquiry_number = session.get('enquiry_number')
            customer_name = session.get('customer_name')
            total_fans = session.get('total_fans')
            fans = session.get('fans', [])
            sales_engineer = session.get('sales_engineer')
            if not enquiry_number or not fans:
                return jsonify({'error': 'No project data found'}), 400

            # --- Define the structure as in the UI ---
            # Section headers and fields (order matters)
            rows = []
            def section(title):
                return {'type': 'section', 'label': title}
            def field(label, key, is_numeric=False, total=True):
                return {'type': 'field', 'label': label, 'key': key, 'is_numeric': is_numeric, 'total': total}

            # Fan Details
            rows.append(section('Fan Details'))
            rows += [
                field('Fan Number', 'fan_number'),
                field('Model', 'fan_model'),
                field('Size', 'fan_size'),
                field('Class', 'class_'),
                field('Arrangement', 'arrangement'),
                field('Material', 'material'),
                field('Vendor', 'vendor'),
                field('Shaft Diameter (mm)', 'shaft_diameter'),
                field('No. of Isolators', 'no_of_isolators'),
                field('Isolator Brand/Type', 'vibration_isolators'),
                field('Bearing Brand', 'bearing_brand'),
                field('Motor Brand', 'motor_brand'),
                field('Motor kW', 'motor_kw'),
                field('Pole', 'pole'),
                field('Efficiency', 'efficiency'),
                field('Motor Discount (%)', 'motor_discount'),
                field('Drive Pack kW', 'drive_pack_kw'),
            ]
            # Weights
            rows.append(section('Weights'))
            rows += [
                field('Bare Fan Weight (kg)', 'bare_fan_weight', is_numeric=True),
                field('Accessory Weight (kg)', 'accessory_weights', is_numeric=True),
                field('Total Weight (kg)', 'total_weight', is_numeric=True),
            ]
            # Cost Summary
            rows.append(section('Cost Summary'))
            rows += [
                field('Fabrication Cost ()', 'fabrication_cost', is_numeric=True),
                field('Fabrication Margin (%)', 'fabrication_margin', is_numeric=True, total=False),
                field('Fabrication Selling Price ()', 'fabrication_selling_price', is_numeric=True),
                field('Bought Out Cost ()', 'bought_out_cost', is_numeric=True),
                field('Bought Out Margin (%)', 'bought_out_margin', is_numeric=True, total=False),
                field('Bought Out Selling Price ()', 'bought_out_selling_price', is_numeric=True),
                field('Total Cost ()', 'total_cost', is_numeric=True),
                field('Total Selling Price ()', 'total_selling_price', is_numeric=True),
                field('Job Margin (%)', 'total_job_margin', is_numeric=True, total=False),
            ]
            # Bought Out Items breakdown
            rows.append(section('Bought Out Items'))
            rows += [
                field('Vibration Isolators', 'vibration_isolators_cost', is_numeric=True),
                field('Bearings', 'bearing_cost', is_numeric=True),
                field('Drive Pack', 'drive_pack_cost', is_numeric=True),
                field('Motor', 'motor_cost', is_numeric=True),
            ]
            # Accessories breakdown (show Included/blank)
            rows.append(section('Accessories'))
            accessories_set = set([
                'unitary_base_frame', 'isolation_base_frame', 'split_casing',
                'inlet_companion_flange', 'outlet_companion_flange', 'inlet_butterfly_damper'
            ])
            # Collect all accessory keys (including custom)
            for fan in fans:
                accs = fan.get('accessories', {})
                for k in accs.keys():
                    accessories_set.add(k)
            for acc in sorted(accessories_set):
                label = acc.replace('_', ' ').title()
                rows.append(field(label, f'accessories.{acc}', is_numeric=False, total=False))
            # Optional Items breakdown (show price or blank)
            rows.append(section('Optional Items'))
            optional_items_set = set([
                'flex_connectors', 'silencer', 'testing_charges', 'freight_charges', 'warranty_charges', 'packing_charges'
            ])
            # Collect all optional item keys (including custom)
            for fan in fans:
                opts = fan.get('optional_items', {})
                for k in opts.keys():
                    optional_items_set.add(k)
            for opt in sorted(optional_items_set):
                label = opt.replace('_', ' ').title()
                rows.append(field(label, f'optional_items.{opt}', is_numeric=True))
            # --- End of structure ---

            # Build columns for each fan
            fan_columns = []
            for fan in fans:
                col = {}
                # Flat fields
                for k in ['fan_number','fan_model','fan_size','class_','arrangement','material','vendor','shaft_diameter','no_of_isolators','vibration_isolators','bearing_brand','motor_brand','motor_kw','pole','efficiency','motor_discount','drive_pack_kw','bare_fan_weight','accessory_weights','total_weight','fabrication_cost','fabrication_margin','fabrication_selling_price','bought_out_cost','bought_out_margin','bought_out_selling_price','total_cost','total_selling_price','total_job_margin','vibration_isolators_cost','bearing_cost','drive_pack_cost','motor_cost']:
                    val = fan.get(k)
                    if val is None:
                        for nest in ['specifications','weights','costs','motor']:
                            if nest in fan and k in fan[nest]:
                                val = fan[nest][k]
                                break
                    col[k] = val if val is not None else ''
                # Accessories (show 'Included' if true)
                accs = fan.get('accessories', {})
                for acc in accessories_set:
                    col[f'accessories.{acc}'] = 'Included' if accs.get(acc) else ''
                # Optional items (show price or blank)
                opts = fan.get('optional_items', {})
                for opt in optional_items_set:
                    v = opts.get(opt)
                    col[f'optional_items.{opt}'] = v if v else ''
                fan_columns.append(col)

            # Build Excel rows
            excel_rows = []
            header = ['Field'] + [f"Fan {i+1}" for i in range(len(fan_columns))]
            excel_rows.append(header)
            for row in rows:
                if row['type'] == 'section':
                    excel_rows.append([row['label']] + ['']*len(fan_columns))
                else:
                    vals = [row['label']]
                    for col in fan_columns:
                        v = col.get(row['key'], '')
                        vals.append(v)
                    excel_rows.append(vals)
            # Totals row (only for numeric fields with total=True)
            totals_row = ['TOTALS']
            for i in range(len(fan_columns)):
                total = 0
                for idx, row in enumerate(rows):
                    if row['type'] == 'field' and row.get('is_numeric') and row.get('total', True):
                        v = fan_columns[i].get(row['key'])
                        try:
                            v = float(v)
                        except (TypeError, ValueError):
                            v = 0
                        total += v
                totals_row.append(total if total != 0 else '')
            excel_rows.append(totals_row)

            # Create Excel file
            filename = f"{enquiry_number}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
            wb = Workbook()
            ws = wb.active
            ws.title = "Project Summary"
            # Add project details
            ws['A1'] = 'Project Summary'
            ws['A1'].font = Font(bold=True, size=16)
            ws.merge_cells('A1:H1')
            ws['A3'] = 'Enquiry Number:'
            ws['B3'] = enquiry_number
            ws['A4'] = 'Customer Name:'
            ws['B4'] = customer_name
            ws['A5'] = 'Sales Engineer:'
            ws['B5'] = sales_engineer
            ws['A6'] = 'Date:'
            ws['B6'] = datetime.now().strftime('%d-%m-%Y')
            ws['D3'] = 'Total Fans:'
            ws['E3'] = total_fans
            # Write rows to Excel
            start_row = 8
            for r, row in enumerate(excel_rows):
                for c, value in enumerate(row):
                    cell = ws.cell(row=start_row + r, column=1 + c)
                    cell.value = value
                    # Section header formatting
                    if r > 0 and rows[r-1]['type'] == 'section' and c == 0:
                        cell.font = Font(bold=True, color='FFFFFF')
                        cell.fill = PatternFill(start_color='4a90e2', end_color='4a90e2', fill_type='solid')
                    # Header formatting
                    if r == 0:
                        cell.font = Font(bold=True, color='FFFFFF')
                        cell.fill = PatternFill(start_color='4a90e2', end_color='4a90e2', fill_type='solid')
                        cell.alignment = Alignment(horizontal='center')
                    # Totals formatting
                    if r == len(excel_rows) - 1:
                        cell.font = Font(bold=True)
                    # Number formatting
                    if isinstance(value, (int, float)):
                        if 'Cost' in row[0] or 'Price' in row[0]:
                            cell.number_format = '#,##0.00'
                        elif 'Weight' in row[0]:
                            cell.number_format = '#,##0.00" kg"'
                        elif 'Margin' in row[0]:
                            cell.number_format = '#,##0.00"%"'
                        else:
                            cell.number_format = '#,##0.00'
            # Add borders and auto-fit columns
            thin_border = Border(left=Side(style='thin'), right=Side(style='thin'), top=Side(style='thin'), bottom=Side(style='thin'))
            for row in ws.iter_rows(min_row=start_row, max_row=start_row+len(excel_rows)-1):
                for cell in row:
                    cell.border = thin_border
            for column in ws.columns:
                max_length = 0
                column = list(column)
                for cell in column:
                    try:
                        if len(str(cell.value)) > max_length:
                            max_length = len(str(cell.value))
                    except:
                        pass
                adjusted_width = (max_length + 2)
                ws.column_dimensions[column[0].column_letter].width = adjusted_width
            wb.save(filename)
            return send_file(
                filename,
                as_attachment=True,
                download_name=filename,
                mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            )
        except Exception as e:
            logger.error(f"Error exporting project summary to Excel: {str(e)}", exc_info=True)
            return jsonify({'error': str(e)}), 500

    @app.route('/get_vendor_rate')
    def get_vendor_rate():
        vendor = request.args.get('vendor')
        material = request.args.get('material', 'ms')
        try:
            total_weight = float(request.args.get('weight', 1))
        except Exception:
            total_weight = 1
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT MSPrice, SS304Price FROM VendorWeightDetails
                WHERE Vendor = ? AND WeightStart <= ? AND WeightEnd > ?
            ''', (vendor, total_weight, total_weight))
            row = cursor.fetchone()
            if not row:
                return jsonify({'rate': None}), 404
            if material == 'ss304':
                return jsonify({'rate': row['SS304Price']})
            else:
                return jsonify({'rate': row['MSPrice']})

    @app.route('/export_summary_excel_full', methods=['GET'])
    @login_required
    def export_summary_excel_full():
        """Export a true replica of the project summary page, including all fields and custom data, to Excel."""
        try:
            enquiry_number = session.get('enquiry_number')
            customer_name = session.get('customer_name')
            total_fans = session.get('total_fans')
            fans = session.get('fans', [])
            sales_engineer = session.get('sales_engineer')
            if not enquiry_number or not fans:
                return jsonify({'error': 'No project data found'}), 400

            # Dynamically collect all possible fields from all fans
            all_fields = set()
            all_accessories = set()
            all_optional_items = set()
            for fan in fans:
                all_fields.update(fan.keys())
                if 'accessories' in fan and isinstance(fan['accessories'], dict):
                    all_accessories.update(fan['accessories'].keys())
                if 'optional_items' in fan and isinstance(fan['optional_items'], dict):
                    all_optional_items.update(fan['optional_items'].keys())

            # Define sections and their likely fields (order matters, but add any extras at the end)
            sections = [
                ('Fan Details', [
                    'fan_number','fan_model','fan_size','class_','arrangement','material','vendor','shaft_diameter','no_of_isolators','vibration_isolators','bearing_brand','motor_brand','motor_kw','pole','efficiency','motor_discount','drive_pack_kw'
                ]),
                ('Weights', [
                    'bare_fan_weight','accessory_weights','total_weight'
                ]),
                ('Cost Summary', [
                    'fabrication_cost','fabrication_margin','fabrication_selling_price','bought_out_cost','bought_out_margin','bought_out_selling_price','total_cost','total_selling_price','total_job_margin'
                ]),
                ('Bought Out Items', [
                    'vibration_isolators_cost','bearing_cost','drive_pack_cost','motor_cost'
                ]),
                ('Accessories', sorted(all_accessories)),
                ('Optional Items', sorted(all_optional_items)),
            ]
            # Add any extra fields not in the above
            used_fields = set()
            for _, fields in sections:
                used_fields.update(fields)
            extra_fields = sorted(all_fields - used_fields - {'accessories','optional_items'})
            if extra_fields:
                sections.append(('Other Fields', extra_fields))

            # Build rows for Excel
            rows = []
            for section_name, field_list in sections:
                rows.append({'type': 'section', 'label': section_name})
                for field in field_list:
                    label = field.replace('_', ' ').replace('.', ' ').title()
                    rows.append({'type': 'field', 'label': label, 'key': field})

            # Build columns for each fan
            fan_columns = []
            for fan in fans:
                col = {}
                for field in all_fields:
                    val = fan.get(field, '')
                    # For accessories and optional_items, flatten
                    if field == 'accessories' and isinstance(val, dict):
                        for acc in all_accessories:
                            col[f'accessories.{acc}'] = 'Included' if val.get(acc) else ''
                    elif field == 'optional_items' and isinstance(val, dict):
                        for opt in all_optional_items:
                            v = val.get(opt)
                            col[f'optional_items.{opt}'] = v if v else ''
                    else:
                        col[field] = val
                fan_columns.append(col)

            # Build Excel rows
            excel_rows = []
            header = ['Field'] + [f"Fan {i+1}" for i in range(len(fan_columns))]
            excel_rows.append(header)
            for row in rows:
                if row['type'] == 'section':
                    excel_rows.append([row['label']] + ['']*len(fan_columns))
                else:
                    vals = [row['label']]
                    for col in fan_columns:
                        v = col.get(row['key'], '')
                        # For accessories/optional_items, use flattened keys
                        if row['key'].startswith('accessories.'):
                            v = col.get(row['key'], '')
                        if row['key'].startswith('optional_items.'):
                            v = col.get(row['key'], '')
                        vals.append(v)
                    excel_rows.append(vals)
            # Totals row (only for numeric fields)
            totals_row = ['TOTALS']
            for i in range(len(fan_columns)):
                total = 0
                for row in rows:
                    if row['type'] == 'field':
                        v = fan_columns[i].get(row['key'])
                        try:
                            v = float(v)
                        except (TypeError, ValueError):
                            v = 0
                        if isinstance(v, (int, float)) and not isinstance(v, bool):
                            total += v
                totals_row.append(total if total != 0 else '')
            excel_rows.append(totals_row)

            # Create Excel file
            filename = f"{enquiry_number}_summary_full_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
            wb = Workbook()
            ws = wb.active
            ws.title = "Project Summary Full"
            # Add project details
            ws['A1'] = 'Project Summary (Full Export)'
            ws['A1'].font = Font(bold=True, size=16)
            ws.merge_cells('A1:H1')
            ws['A3'] = 'Enquiry Number:'
            ws['B3'] = enquiry_number
            ws['A4'] = 'Customer Name:'
            ws['B4'] = customer_name
            ws['A5'] = 'Sales Engineer:'
            ws['B5'] = sales_engineer
            ws['A6'] = 'Date:'
            ws['B6'] = datetime.now().strftime('%d-%m-%Y')
            ws['D3'] = 'Total Fans:'
            ws['E3'] = total_fans
            # Write rows to Excel
            start_row = 8
            for r, row in enumerate(excel_rows):
                for c, value in enumerate(row):
                    cell = ws.cell(row=start_row + r, column=1 + c)
                    cell.value = value
                    # Section header formatting
                    if r > 0 and excel_rows[r-1][0] in [s[0] for s in sections] and c == 0:
                        cell.font = Font(bold=True, color='FFFFFF')
                        cell.fill = PatternFill(start_color='4a90e2', end_color='4a90e2', fill_type='solid')
                    # Header formatting
                    if r == 0:
                        cell.font = Font(bold=True, color='FFFFFF')
                        cell.fill = PatternFill(start_color='4a90e2', end_color='4a90e2', fill_type='solid')
                        cell.alignment = Alignment(horizontal='center')
                    # Totals formatting
                    if r == len(excel_rows) - 1:
                        cell.font = Font(bold=True)
                    # Number formatting
                    if isinstance(value, (int, float)):
                        if 'Cost' in row[0] or 'Price' in row[0]:
                            cell.number_format = '#,##0.00'
                        elif 'Weight' in row[0]:
                            cell.number_format = '#,##0.00" kg"'
                        elif 'Margin' in row[0]:
                            cell.number_format = '#,##0.00"%"'
                        else:
                            cell.number_format = '#,##0.00'
            # Add borders and auto-fit columns
            thin_border = Border(left=Side(style='thin'), right=Side(style='thin'), top=Side(style='thin'), bottom=Side(style='thin'))
            for row in ws.iter_rows(min_row=start_row, max_row=start_row+len(excel_rows)-1):
                for cell in row:
                    cell.border = thin_border
            for column in ws.columns:
                max_length = 0
                column = list(column)
                for cell in column:
                    try:
                        if len(str(cell.value)) > max_length:
                            max_length = len(str(cell.value))
                    except:
                        pass
                adjusted_width = (max_length + 2)
                ws.column_dimensions[column[0].column_letter].width = adjusted_width
            wb.save(filename)
            return send_file(
                filename,
                as_attachment=True,
                download_name=filename,
                mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            )
        except Exception as e:
            logger.error(f"Error exporting full project summary to Excel: {str(e)}", exc_info=True)
            return jsonify({'error': str(e)}), 500

    @app.route('/export_project_summary_excel', methods=['POST'])
    @login_required
    def export_project_summary_excel():
        """Export the exact project summary table sent from the frontend as an Excel file."""
        try:
            data = request.get_json()
            table = data.get('table', [])
            enquiry_number = data.get('enquiry_number', 'Project')
            customer_name = data.get('customer_name', '')
            sales_engineer = data.get('sales_engineer', '')
            filename = f"{enquiry_number}_summary_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
            wb = Workbook()
            ws = wb.active
            ws.title = "Project Summary (UI Copy)"
            # Add project details at the top
            ws['A1'] = 'Project Summary (UI Copy)'
            ws['A1'].font = Font(bold=True, size=16)
            ws.merge_cells('A1:H1')
            ws['A3'] = 'Enquiry Number:'
            ws['B3'] = enquiry_number
            ws['A4'] = 'Customer Name:'
            ws['B4'] = customer_name
            ws['A5'] = 'Sales Engineer:'
            ws['B5'] = sales_engineer
            ws['A6'] = 'Date:'
            ws['B6'] = datetime.now().strftime('%d-%m-%Y')
            # Write the table as-is
            start_row = 8
            for r, row in enumerate(table):
                for c, value in enumerate(row):
                    cell = ws.cell(row=start_row + r, column=1 + c)
                    cell.value = value
                    # Header formatting
                    if r == 0:
                        cell.font = Font(bold=True, color='FFFFFF')
                        cell.fill = PatternFill(start_color='4a90e2', end_color='4a90e2', fill_type='solid')
                        cell.alignment = Alignment(horizontal='center')
                    # Section header formatting
                    if r > 0 and (len(row) == 1 or (row[0] and not row[1:])):
                        cell.font = Font(bold=True, color='FFFFFF')
                        cell.fill = PatternFill(start_color='4a90e2', end_color='4a90e2', fill_type='solid')
                    # Totals formatting
                    if 'TOTAL' in str(row[0]).upper():
                        cell.font = Font(bold=True)
            # Add borders and auto-fit columns
            thin_border = Border(left=Side(style='thin'), right=Side(style='thin'), top=Side(style='thin'), bottom=Side(style='thin'))
            for row in ws.iter_rows(min_row=start_row, max_row=start_row+len(table)-1):
                for cell in row:
                    cell.border = thin_border
            for column in ws.columns:
                max_length = 0
                column = list(column)
                for cell in column:
                    try:
                        if len(str(cell.value)) > max_length:
                            max_length = len(str(cell.value))
                    except:
                        pass
                adjusted_width = (max_length + 2)
                ws.column_dimensions[column[0].column_letter].width = adjusted_width
            wb.save(filename)
            return send_file(
                filename,
                as_attachment=True,
                download_name=filename,
                mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            )
        except Exception as e:
            logger.error(f"Error exporting UI project summary to Excel: {str(e)}", exc_info=True)
            return jsonify({'error': str(e)}), 500

    return app 